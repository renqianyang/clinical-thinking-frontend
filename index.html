<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸´åºŠæ€ç»´è®­ç»ƒç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 30px; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .gap-4 { gap: 16px; }
        .gap-6 { gap: 24px; }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            height: fit-content;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: #666;
            margin-bottom: 4px;
        }
        .nav-item:hover { background: #f5f7fa; color: #667eea; }
        .nav-item.active { background: #eef2ff; color: #667eea; font-weight: 500; }

        /* Main Content */
        .main-content { flex: 1; }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-title { font-size: 18px; font-weight: 600; color: #333; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
        }
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-label { color: #666; font-size: 14px; margin-top: 8px; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-danger { background: #ff4444; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }

        /* Tables */
        .table-container { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
        }
        th {
            color: #666;
            font-weight: 500;
            font-size: 13px;
            text-transform: uppercase;
        }
        td { color: #333; font-size: 14px; }
        tr:hover { background: #f9fafb; }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-blue { background: #e3f2fd; color: #1976d2; }
        .badge-green { background: #e8f5e9; color: #388e3c; }
        .badge-yellow { background: #fff3e0; color: #f57c00; }
        .badge-red { background: #ffebee; color: #c62828; }

        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title { font-size: 20px; font-weight: 600; }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* Array Inputs */
        .array-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .array-item input { flex: 1; }

        /* Login Page */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-logo-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
        }
        .login-logo h1 { font-size: 24px; color: #333; }
        .login-logo p { color: #666; font-size: 14px; margin-top: 8px; }

        /* Training Page */
        .training-layout {
            display: flex;
            height: calc(100vh - 70px);
        }
        .training-sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #eee;
            padding: 20px;
            overflow-y: auto;
        }
        .training-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f9fafb;
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .chat-message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }
        .chat-message.user { align-items: flex-end; }
        .chat-message.ai { align-items: flex-start; }
        .chat-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
        }
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-message.ai .chat-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 12px;
        }
        .chat-input-area input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: #f0f0f0;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }
        .tab.active { background: white; color: #667eea; }

        /* Utility */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: 16px; }
        .mb-4 { margin-bottom: 16px; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .w-full { width: 100%; }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Error message */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        .error-message.show { display: block; }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="login-logo">
                <div class="login-logo-icon">ğŸ¥</div>
                <h1>ä¸´åºŠæ€ç»´è®­ç»ƒç³»ç»Ÿ</h1>
                <p>Clinical Thinking Training System</p>
            </div>

            <div class="error-message" id="loginError"></div>

            <form id="loginForm">
                <div class="tabs">
                    <div class="tab active" data-role="teacher">ğŸ‘¨â€âš•ï¸ æ•™å¸ˆ</div>
                    <div class="tab" data-role="student">ğŸ‘¨â€ğŸ“ å­¦ç”Ÿ</div>
                </div>

                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>

                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>

                <button type="submit" class="btn btn-primary w-full" id="loginBtn">
                    ç™»å½•
                </button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <span style="font-size: 24px;">ğŸ¥</span>
                <h1>ä¸´åºŠæ€ç»´è®­ç»ƒç³»ç»Ÿ</h1>
            </div>
            <div class="header-right">
                <span id="userName"></span>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </header>

        <div class="container flex gap-6">
            <!-- Sidebar -->
            <aside class="sidebar">
                <nav id="sidebarNav">
                    <!-- Navigation items will be inserted here -->
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="main-content" id="mainContent">
                <!-- Content will be inserted here -->
            </main>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle"></h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // ==================== CONFIG ====================
        const API_BASE = 'https://clinical-thinking-backend.onrender.com';
        let currentUser = null;
        let currentToken = null;
        let currentPage = 'dashboard';

        // ==================== AUTH ====================
        function init() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                currentToken = token;
                currentUser = JSON.parse(user);
                showMainApp();
            } else {
                showLoginPage();
            }
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.full_name;
            renderSidebar();
            navigate('dashboard');
        }

        function logout() {
            localStorage.clear();
            currentUser = null;
            currentToken = null;
            showLoginPage();
        }

        // Login form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const role = document.querySelector('.tab.active').dataset.role;
            const btn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            
            btn.innerHTML = 'ç™»å½•ä¸­<span class="loading"></span>';
            btn.disabled = true;
            errorDiv.classList.remove('show');
            
            try {
                const res = await fetch(`${API_BASE}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    currentToken = data.access_token;
                    localStorage.setItem('token', currentToken);
                    
                    const userRes = await fetch(`${API_BASE}/auth/me`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    });
                    
                    currentUser = await userRes.json();
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showMainApp();
                } else {
                    throw new Error(data.detail || 'ç™»å½•å¤±è´¥');
                }
            } catch (err) {
                errorDiv.textContent = err.message;
                errorDiv.classList.add('show');
            }
            
            btn.innerHTML = 'ç™»å½•';
            btn.disabled = false;
        });

        // Role tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
            });
        });

        // ==================== NAVIGATION ====================
        function renderSidebar() {
            const nav = document.getElementById('sidebarNav');
            const isTeacher = currentUser.role === 'teacher';
            
            const items = isTeacher ? [
                { id: 'dashboard', label: 'ğŸ“Š é¦–é¡µ', page: 'dashboard' },
                { id: 'cases', label: 'ğŸ“š ç—…ä¾‹ç®¡ç†', page: 'teacherCases' },
                { id: 'classes', label: 'ğŸ‘¥ ç­çº§ç®¡ç†', page: 'teacherClasses' },
                { id: 'stats', label: 'ğŸ“ˆ æ•°æ®ç»Ÿè®¡', page: 'teacherStats' }
            ] : [
                { id: 'dashboard', label: 'ğŸ“Š é¦–é¡µ', page: 'dashboard' },
                { id: 'cases', label: 'ğŸ“š ç—…ä¾‹åº“', page: 'studentCases' },
                { id: 'history', label: 'ğŸ“œ è®­ç»ƒå†å²', page: 'history' },
                { id: 'ranking', label: 'ğŸ† æ’è¡Œæ¦œ', page: 'ranking' }
            ];
            
            nav.innerHTML = items.map(item => `
                <div class="nav-item ${currentPage === item.page ? 'active' : ''}" 
                     onclick="navigate('${item.page}')">
                    ${item.label}
                </div>
            `).join('');
        }

        function navigate(page) {
            currentPage = page;
            renderSidebar();
            
            const pages = {
                dashboard: renderDashboard,
                teacherCases: renderTeacherCases,
                teacherClasses: renderTeacherClasses,
                teacherStats: renderTeacherStats,
                studentCases: renderStudentCases,
                history: renderHistory,
                ranking: renderRanking
            };
            
            if (pages[page]) {
                pages[page]();
            }
        }

        // ==================== PAGES ====================
        async function renderDashboard() {
            const content = document.getElementById('mainContent');
            
            try {
                const endpoint = currentUser.role === 'teacher' ? '/stats/teacher' : '/stats/student';
                const stats = await apiGet(endpoint);
                
                const isTeacher = currentUser.role === 'teacher';
                
                content.innerHTML = `
                    <div class="card gradient-bg text-white">
                        <h2>æ¬¢è¿å›æ¥ï¼Œ${currentUser.full_name}ï¼</h2>
                        <p>${isTeacher ? 'ç®¡ç†æ‚¨çš„ç­çº§å’Œç—…ä¾‹ï¼Œè¿½è¸ªå­¦ç”Ÿå­¦ä¹ è¿›åº¦' : 'å¼€å§‹ä»Šå¤©çš„è®­ç»ƒï¼Œæå‡æ‚¨çš„ä¸´åºŠæ€ç»´èƒ½åŠ›'}</p>
                    </div>
                    
                    <div class="stats-grid">
                        ${isTeacher ? `
                            <div class="stat-card">
                                <div class="stat-value">${stats.total_classes || 0}</div>
                                <div class="stat-label">æˆ‘çš„ç­çº§</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.total_students || 0}</div>
                                <div class="stat-label">å­¦ç”Ÿäººæ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.total_cases_created || 0}</div>
                                <div class="stat-label">åˆ›å»ºç—…ä¾‹</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.total_sessions || 0}</div>
                                <div class="stat-label">è®­ç»ƒæ¬¡æ•°</div>
                            </div>
                        ` : `
                            <div class="stat-card">
                                <div class="stat-value">${stats.total_sessions || 0}</div>
                                <div class="stat-label">æ€»è®­ç»ƒæ¬¡æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.completed_sessions || 0}</div>
                                <div class="stat-label">å·²å®Œæˆ</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.average_score ? stats.average_score.toFixed(0) : '-'}</div>
                                <div class="stat-label">å¹³å‡åˆ†</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.total_cases_attempted || 0}</div>
                                <div class="stat-label">å°è¯•ç—…ä¾‹æ•°</div>
                            </div>
                        `}
                    </div>
                `;
            } catch (err) {
                content.innerHTML = '<div class="card">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }

        // Teacher Cases
        async function renderTeacherCases() {
            const content = document.getElementById('mainContent');
            content.innerHTML = '<div class="card">åŠ è½½ä¸­...</div>';
            
            try {
                const cases = await apiGet('/cases');
                
                content.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ç—…ä¾‹ç®¡ç†</h2>
                            <div class="flex gap-2">
                                <button class="btn btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);" onclick="openAICaseModal()">
                                    ğŸ¤– AIåˆ›å»º
                                </button>
                                <button class="btn btn-primary" onclick="openCaseModal()">
                                    â• æ‰‹åŠ¨åˆ›å»º
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>æ ‡é¢˜</th>
                                        <th>éš¾åº¦</th>
                                        <th>è¯Šæ–­</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${cases.map(c => `
                                        <tr>
                                            <td>${c.title}</td>
                                            <td><span class="badge badge-blue">${c.difficulty}</span></td>
                                            <td>${c.diagnosis}</td>
                                            <td>${new Date(c.created_at).toLocaleDateString()}</td>
                                            <td>
                                                <div class="flex gap-2">
                                                    <button class="btn btn-sm btn-secondary" onclick="viewCase(${c.id})">æŸ¥çœ‹</button>
                                                    <button class="btn btn-sm btn-secondary" onclick="editCase(${c.id})">ç¼–è¾‘</button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteCase(${c.id})">åˆ é™¤</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (err) {
                content.innerHTML = '<div class="card">åŠ è½½å¤±è´¥</div>';
            }
        }

        // Teacher Classes
        async function renderTeacherClasses() {
            const content = document.getElementById('mainContent');
            content.innerHTML = '<div class="card">åŠ è½½ä¸­...</div>';
            
            try {
                const classes = await apiGet('/classes');
                
                content.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">ç­çº§ç®¡ç†</h2>
                            <button class="btn btn-primary" onclick="openClassModal()">
                                â• åˆ›å»ºç­çº§
                            </button>
                        </div>
                        
                        <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                            ${classes.map(c => `
                                <div class="card" style="margin-bottom: 0;">
                                    <div class="flex justify-between items-start mb-3">
                                        <h3>${c.name}</h3>
                                        <div class="flex gap-2">
                                            <button class="btn btn-sm btn-secondary" onclick="manageClass(${c.id})">ç®¡ç†</button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteClass(${c.id})">åˆ é™¤</button>
                                        </div>
                                    </div>
                                    <p class="text-gray-500">å­¦ç”Ÿäººæ•°ï¼š${c.students?.length || 0}äºº</p>
                                    <p class="text-gray-400 text-sm mt-2">åˆ›å»ºäº ${new Date(c.created_at).toLocaleDateString()}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (err) {
                content.innerHTML = '<div class="card">åŠ è½½å¤±è´¥</div>';
            }
        }

        // Teacher Stats
        function renderTeacherStats() {
            document.getElementById('mainContent').innerHTML = `
                <div class="card">
                    <h2 class="card-title">æ•°æ®ç»Ÿè®¡</h2>
                    <p class="text-gray-500 mt-4">æ•°æ®ç»Ÿè®¡åŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
            `;
        }

        // Student Cases
        async function renderStudentCases() {
            const content = document.getElementById('mainContent');
            content.innerHTML = '<div class="card">åŠ è½½ä¸­...</div>';
            
            try {
                const cases = await apiGet('/cases');
                
                content.innerHTML = `
                    <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                        ${cases.map(c => `
                            <div class="card" style="display: flex; flex-direction: column;">
                                <div style="flex: 1;">
                                    <div class="flex justify-between items-start mb-3">
                                        <h3>${c.title}</h3>
                                        <span class="badge badge-blue">${c.difficulty}</span>
                                    </div>
                                    <p class="text-gray-600 text-sm mb-4">${c.description.substring(0, 100)}...</p>
                                    <div class="flex items-center gap-4 text-sm text-gray-500">
                                        <span>ğŸ‘¤ ${c.patient_info?.age}å²${c.patient_info?.gender === 'male' ? 'ç”·' : 'å¥³'}</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary w-full mt-4" onclick="startTraining(${c.id})">
                                    å¼€å§‹è®­ç»ƒ
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (err) {
                content.innerHTML = '<div class="card">åŠ è½½å¤±è´¥</div>';
            }
        }

        // History
        async function renderHistory() {
            const content = document.getElementById('mainContent');
            content.innerHTML = '<div class="card">åŠ è½½ä¸­...</div>';
            
            try {
                const sessions = await apiGet('/sessions');
                
                content.innerHTML = `
                    <div class="card">
                        <h2 class="card-title mb-4">è®­ç»ƒå†å²</h2>
                        
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ç—…ä¾‹</th>
                                        <th>çŠ¶æ€</th>
                                        <th>å¾—åˆ†</th>
                                        <th>æ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sessions.map(s => `
                                        <tr>
                                            <td>${s.case?.title || 'æœªçŸ¥ç—…ä¾‹'}</td>
                                            <td>
                                                <span class="badge ${s.status === 'completed' ? 'badge-green' : 'badge-yellow'}">
                                                    ${s.status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}
                                                </span>
                                            </td>
                                            <td>${s.score !== null ? s.score + 'åˆ†' : '-'}</td>
                                            <td>${new Date(s.started_at).toLocaleDateString()}</td>
                                            <td>
                                                ${s.status === 'completed' 
                                                    ? `<button class="btn btn-sm btn-secondary" onclick="viewReport(${s.id})">æŸ¥çœ‹æŠ¥å‘Š</button>`
                                                    : `<button class="btn btn-sm btn-primary" onclick="continueTraining(${s.id})">ç»§ç»­è®­ç»ƒ</button>`
                                                }
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (err) {
                content.innerHTML = '<div class="card">åŠ è½½å¤±è´¥</div>';
            }
        }

        // Ranking
        function renderRanking() {
            document.getElementById('mainContent').innerHTML = `
                <div class="card">
                    <h2 class="card-title">æ’è¡Œæ¦œ</h2>
                    <p class="text-gray-500 mt-4">æ’è¡Œæ¦œåŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
            `;
        }

        // ==================== API HELPERS ====================
        async function apiGet(url) {
            const res = await fetch(API_BASE + url, {
                headers: { 'Authorization': `Bearer ${currentToken}` }
            });
            if (!res.ok) throw new Error('API Error');
            return res.json();
        }

        async function apiPost(url, data) {
            const res = await fetch(API_BASE + url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${currentToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('API Error');
            return res.json();
        }

        async function apiDelete(url) {
            const res = await fetch(API_BASE + url, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${currentToken}` }
            });
            if (!res.ok) throw new Error('API Error');
        }

        // ==================== MODAL FUNCTIONS ====================
        function openModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

        // AI Create Case Modal
        function openAICaseModal() {
            const content = `
                <form id="aiCaseForm" onsubmit="generateCaseWithAI(event)">
                    <div class="form-group">
                        <label>ç—…ç§ç±»å‹ *</label>
                        <select name="diseaseType" required>
                            <option value="">è¯·é€‰æ‹©ç—…ç§</option>
                            <option value="å¿ƒè¡€ç®¡ç–¾ç—…">å¿ƒè¡€ç®¡ç–¾ç—…</option>
                            <option value="å‘¼å¸ç³»ç»Ÿç–¾ç—…">å‘¼å¸ç³»ç»Ÿç–¾ç—…</option>
                            <option value="æ¶ˆåŒ–ç³»ç»Ÿç–¾ç—…">æ¶ˆåŒ–ç³»ç»Ÿç–¾ç—…</option>
                            <option value="ç¥ç»ç³»ç»Ÿç–¾ç—…">ç¥ç»ç³»ç»Ÿç–¾ç—…</option>
                            <option value="å†…åˆ†æ³Œç³»ç»Ÿç–¾ç—…">å†…åˆ†æ³Œç³»ç»Ÿç–¾ç—…</option>
                            <option value="æ³Œå°¿ç³»ç»Ÿç–¾ç—…">æ³Œå°¿ç³»ç»Ÿç–¾ç—…</option>
                            <option value="è¡€æ¶²ç³»ç»Ÿç–¾ç—…">è¡€æ¶²ç³»ç»Ÿç–¾ç—…</option>
                            <option value="æ„ŸæŸ“æ€§ç–¾ç—…">æ„ŸæŸ“æ€§ç–¾ç—…</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>éš¾åº¦ *</label>
                        <select name="difficulty" required>
                            <option value="ç®€å•">ç®€å•</option>
                            <option value="ä¸­ç­‰" selected>ä¸­ç­‰</option>
                            <option value="å›°éš¾">å›°éš¾</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ç‰¹æ®Šè¦æ±‚ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" name="special" placeholder="å¦‚ï¼šåˆå¹¶ç³–å°¿ç—…ã€è€å¹´æ‚£è€…ç­‰">
                    </div>
                    
                    <div id="aiGenerating" class="text-center hidden">
                        <div style="font-size: 40px; margin-bottom: 16px;">âœ¨</div>
                        <p>AIæ­£åœ¨ç”Ÿæˆç—…ä¾‹ï¼Œè¯·ç¨å€™...</p>
                        <div class="loading" style="border-color: #e0e0e0; border-top-color: #667eea; margin: 12px auto;"></div>
                    </div>
                    
                    <div id="aiPreview" class="hidden">
                        <h4 style="margin-bottom: 12px;">ğŸ“‹ é¢„è§ˆç”Ÿæˆçš„ç—…ä¾‹</h4>
                        <div id="aiPreviewContent" style="background: #f9fafb; padding: 16px; border-radius: 10px; margin-bottom: 16px; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary" id="aiGenerateBtn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            âœ¨ ç”Ÿæˆç—…ä¾‹
                        </button>
                        <button type="button" class="btn btn-primary hidden" id="aiSaveBtn" onclick="saveAIGeneratedCase()">
                            ğŸ’¾ ä¿å­˜ç—…ä¾‹
                        </button>
                    </div>
                </form>
            `;
            openModal('âœ¨ AIç”Ÿæˆç—…ä¾‹', content);
        }

        let generatedCaseData = null;

        async function generateCaseWithAI(e) {
            e.preventDefault();
            
            const form = e.target;
            const diseaseType = form.diseaseType.value;
            const difficulty = form.difficulty.value;
            const special = form.special.value;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('aiGenerating').classList.remove('hidden');
            document.getElementById('aiGenerateBtn').classList.add('hidden');
            document.getElementById('aiPreview').classList.add('hidden');
            
            // æ¨¡æ‹ŸAIç”Ÿæˆï¼ˆä½¿ç”¨æ¨¡æ¿ï¼‰
            setTimeout(() => {
                generatedCaseData = generateMockCase(diseaseType, difficulty, special);
                
                // æ˜¾ç¤ºé¢„è§ˆ
                document.getElementById('aiGenerating').classList.add('hidden');
                document.getElementById('aiPreview').classList.remove('hidden');
                document.getElementById('aiSaveBtn').classList.remove('hidden');
                
                document.getElementById('aiPreviewContent').innerHTML = `
                    <p><strong>æ ‡é¢˜ï¼š</strong>${generatedCaseData.title}</p>
                    <p><strong>è¯Šæ–­ï¼š</strong>${generatedCaseData.diagnosis}</p>
                    <p><strong>éš¾åº¦ï¼š</strong><span class="badge badge-blue">${generatedCaseData.difficulty}</span></p>
                    <p><strong>æ‚£è€…ï¼š</strong>${generatedCaseData.patient_info?.age}å² ${generatedCaseData.patient_info?.gender === 'male' ? 'ç”·' : 'å¥³'}</p>
                    <p><strong>æè¿°ï¼š</strong>${generatedCaseData.description}</p>
                    <p><strong>ç—‡çŠ¶ï¼š</strong>${generatedCaseData.symptoms?.join('ã€') || '-'}</p>
                    <p><strong>é—®è¯Šé—®é¢˜ï¼š</strong></p>
                    <ul style="margin-left: 20px;">
                        ${generatedCaseData.questions?.map((q, i) => `<li>${q} â†’ ${generatedCaseData.answers?.[i] || 'å¾…å›ç­”'}</li>`).join('')}
                    </ul>
                `;
            }, 1500);
        }

        function generateMockCase(diseaseType, difficulty, special) {
            const cases = {
                'å¿ƒè¡€ç®¡ç–¾ç—…': {
                    title: 'æ€¥æ€§èƒ¸ç—›æ‚£è€…',
                    description: 'æ‚£è€…çªå‘èƒ¸ç—›2å°æ—¶ï¼Œä¼´æœ‰å‡ºæ±—ã€æ¶å¿ƒã€‚æ—¢å¾€æœ‰é«˜è¡€å‹ç—…å²ã€‚' + (special ? `åˆå¹¶${special}ã€‚` : ''),
                    diagnosis: 'æ€¥æ€§å¿ƒè‚Œæ¢—æ­»',
                    symptoms: ['èƒ¸ç—›', 'å‡ºæ±—', 'æ¶å¿ƒ', 'å‘¼å¸å›°éš¾'],
                    questions: ['ç–¼ç—›éƒ¨ä½ï¼Ÿ', 'ç–¼ç—›æ€§è´¨ï¼Ÿ', 'æŒç»­æ—¶é—´ï¼Ÿ', 'æ—¢å¾€ç—…å²ï¼Ÿ'],
                    answers: ['èƒ¸éª¨å', 'å‹æ¦¨æ€§ç–¼ç—›', 'æŒç»­2å°æ—¶', 'é«˜è¡€å‹5å¹´']
                },
                'å‘¼å¸ç³»ç»Ÿç–¾ç—…': {
                    title: 'æ…¢æ€§å’³å—½æ‚£è€…',
                    description: 'æ‚£è€…å’³å—½3ä¸ªæœˆï¼Œå’³ç™½è‰²é»ç—°ï¼Œæ´»åŠ¨åæ°”ä¿ƒã€‚å¸çƒŸå²20å¹´ã€‚' + (special ? `åˆå¹¶${special}ã€‚` : ''),
                    diagnosis: 'æ…¢æ€§é˜»å¡æ€§è‚ºç–¾ç—…',
                    symptoms: ['æ…¢æ€§å’³å—½', 'å’³ç—°', 'æ°”ä¿ƒ', 'èƒ¸é—·'],
                    questions: ['å’³å—½å¤šä¹…äº†ï¼Ÿ', 'ç—°æ¶²æ€§çŠ¶ï¼Ÿ', 'å¸çƒŸå²ï¼Ÿ', 'æ´»åŠ¨å—é™ï¼Ÿ'],
                    answers: ['3ä¸ªæœˆ', 'ç™½è‰²é»ç—°', 'å¸çƒŸ20å¹´', 'ä¸Šæ¥¼æ°”ä¿ƒ']
                },
                'æ¶ˆåŒ–ç³»ç»Ÿç–¾ç—…': {
                    title: 'è…¹ç—›æ‚£è€…',
                    description: 'æ‚£è€…ä¸Šè…¹ç—›1å‘¨ï¼Œé¤ååŠ é‡ï¼Œä¼´åé…¸å—³æ°”ã€‚æ— é»‘ä¾¿ã€‚' + (special ? `åˆå¹¶${special}ã€‚` : ''),
                    diagnosis: 'èƒƒæºƒç–¡',
                    symptoms: ['ä¸Šè…¹ç—›', 'åé…¸', 'å—³æ°”', 'é¤åç—›'],
                    questions: ['ç–¼ç—›éƒ¨ä½ï¼Ÿ', 'ä¸è¿›é£Ÿå…³ç³»ï¼Ÿ', 'æœ‰æ— é»‘ä¾¿ï¼Ÿ', 'æ—¢å¾€èƒƒç—…ï¼Ÿ'],
                    answers: ['ä¸Šè…¹éƒ¨', 'é¤ååŠ é‡', 'æ— é»‘ä¾¿', 'å¶æœ‰èƒƒç—›']
                },
                'ç¥ç»ç³»ç»Ÿç–¾ç—…': {
                    title: 'å¤´ç—›æ‚£è€…',
                    description: 'æ‚£è€…çªå‘å‰§çƒˆå¤´ç—›ï¼Œä¼´æ¶å¿ƒå‘•åï¼Œé¢ˆéƒ¨åƒµç¡¬ã€‚' + (special ? `åˆå¹¶${special}ã€‚` : ''),
                    diagnosis: 'è››ç½‘è†œä¸‹è…”å‡ºè¡€',
                    symptoms: ['å‰§çƒˆå¤´ç—›', 'æ¶å¿ƒå‘•å', 'é¢ˆéƒ¨åƒµç¡¬', 'ç•å…‰'],
                    questions: ['å¤´ç—›æ€§è´¨ï¼Ÿ', 'å‘ç—…æ€¥ç¼“ï¼Ÿ', 'é¢ˆéƒ¨ç—‡çŠ¶ï¼Ÿ', 'æ„è¯†çŠ¶æ€ï¼Ÿ'],
                    answers: ['ç‚¸è£‚æ ·å‰§ç—›', 'çªå‘', 'é¢ˆéƒ¨åƒµç¡¬', 'æ¸…é†’']
                },
                'å†…åˆ†æ³Œç³»ç»Ÿç–¾ç—…': {
                    title: 'å¤šé¥®å¤šå°¿æ‚£è€…',
                    description: 'æ‚£è€…å¤šé¥®å¤šå°¿3ä¸ªæœˆï¼Œä½“é‡ä¸‹é™5kgï¼Œä¹åŠ›æ˜æ˜¾ã€‚' + (special ? `åˆå¹¶${special}ã€‚` : ''),
                    diagnosis: '2å‹ç³–å°¿ç—…',
                    symptoms: ['å¤šé¥®', 'å¤šå°¿', 'ä½“é‡ä¸‹é™', 'ä¹åŠ›'],
                    questions: ['ç—‡çŠ¶å¤šä¹…ï¼Ÿ', 'ä½“é‡å˜åŒ–ï¼Ÿ', 'å®¶æ—å²ï¼Ÿ', 'é¥®é£Ÿæƒ…å†µï¼Ÿ'],
                    answers: ['3ä¸ªæœˆ', 'ä¸‹é™5kg', 'çˆ¶äº²ç³–å°¿ç—…', 'é£Ÿæ¬²äº¢è¿›']
                },
                'æ³Œå°¿ç³»ç»Ÿç–¾ç—…': {
                    title: 'è¡€å°¿æ‚£è€…',
                    description: 'æ‚£è€…æ— ç—›æ€§è‚‰çœ¼è¡€å°¿2å¤©ï¼Œæ— å°¿é¢‘å°¿æ€¥ã€‚' + (special ? `åˆå¹¶${special}ã€‚` : ''),
                    diagnosis: 'è†€èƒ±è‚¿ç˜¤',
                    symptoms: ['è¡€å°¿', 'æ— ç—›æ€§', 'è‚‰çœ¼å¯è§', 'æ— åˆºæ¿€ç—‡çŠ¶'],
                    questions: ['è¡€å°¿ç‰¹ç‚¹ï¼Ÿ', 'ç–¼ç—›æƒ…å†µï¼Ÿ', 'æ’å°¿å¼‚å¸¸ï¼Ÿ', 'æ—¢å¾€ç—…å²ï¼Ÿ'],
                    answers: ['å…¨ç¨‹è¡€å°¿', 'æ— ç—›', 'æ— å°¿é¢‘å°¿æ€¥', 'æ— ç‰¹æ®Šç—…å²']
                },
                'è¡€æ¶²ç³»ç»Ÿç–¾ç—…': {
                    title: 'è´«è¡€æ‚£è€…',
                    description: 'æ‚£è€…é¢è‰²è‹ç™½ã€ä¹åŠ›2ä¸ªæœˆï¼Œæœˆç»é‡å¢å¤šã€‚' + (special ? `åˆå¹¶${special}ã€‚` : ''),
                    diagnosis: 'ç¼ºé“æ€§è´«è¡€',
                    symptoms: ['é¢è‰²è‹ç™½', 'ä¹åŠ›', 'å¤´æ™•', 'å¿ƒæ‚¸'],
                    questions: ['ç—‡çŠ¶å¤šä¹…ï¼Ÿ', 'æœˆç»æƒ…å†µï¼Ÿ', 'é¥®é£Ÿæƒ…å†µï¼Ÿ', 'é»‘ä¾¿å²ï¼Ÿ'],
                    answers: ['2ä¸ªæœˆ', 'é‡å¢å¤š', 'åé£Ÿ', 'æ— é»‘ä¾¿']
                },
                'æ„ŸæŸ“æ€§ç–¾ç—…': {
                    title: 'å‘çƒ­æ‚£è€…',
                    description: 'æ‚£è€…é«˜çƒ­3å¤©ï¼Œä¼´å¯’æˆ˜ã€å’³å—½ï¼Œè¿‘æœŸæœ‰å¤–å‡ºå²ã€‚' + (special ? `åˆå¹¶${special}ã€‚` : ''),
                    diagnosis: 'è‚ºç‚',
                    symptoms: ['é«˜çƒ­', 'å¯’æˆ˜', 'å’³å—½', 'èƒ¸ç—›'],
                    questions: ['å‘çƒ­ç‰¹ç‚¹ï¼Ÿ', 'ä¼´éšç—‡çŠ¶ï¼Ÿ', 'æ¥è§¦å²ï¼Ÿ', 'ç”¨è¯å²ï¼Ÿ'],
                    answers: ['æŒç»­é«˜çƒ­', 'å’³å—½å’³ç—°', 'è¿‘æœŸå¤–å‡º', 'æœªç”¨è¯']
                }
            };
            
            const baseCase = cases[diseaseType] || cases['å¿ƒè¡€ç®¡ç–¾ç—…'];
            
            return {
                title: special ? `${baseCase.title}ï¼ˆ${special}ï¼‰` : baseCase.title,
                description: baseCase.description,
                difficulty: difficulty,
                diagnosis: baseCase.diagnosis,
                patient_info: { 
                    age: 45 + Math.floor(Math.random() * 40), 
                    gender: Math.random() > 0.5 ? 'male' : 'female', 
                    extra: special || '' 
                },
                symptoms: baseCase.symptoms,
                questions: baseCase.questions,
                answers: baseCase.answers
            };
        }

        async function saveAIGeneratedCase() {
            if (!generatedCaseData) return;
            
            try {
                await apiPost('/cases', generatedCaseData);
                closeModal();
                renderTeacherCases();
                alert('AIç—…ä¾‹ç”ŸæˆæˆåŠŸï¼');
            } catch (err) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + err.message);
            }
        }

        // Case Modal
        function openCaseModal(caseData = null) {
            const isEdit = !!caseData;
            const content = `
                <form id="caseForm" onsubmit="saveCase(event, ${caseData?.id || 'null'})">
                    <div class="form-group">
                        <label>ç—…ä¾‹æ ‡é¢˜ *</label>
                        <input type="text" name="title" value="${caseData?.title || ''}" placeholder="å¦‚ï¼šæ€¥æ€§èƒ¸ç—›ç—…ä¾‹" required>
                    </div>
                    
                    <div class="form-group">
                        <label>ç—…ä¾‹æè¿° *</label>
                        <textarea name="description" rows="3" placeholder="æè¿°æ‚£è€…ä¸»è¯‰å’ŒåŸºæœ¬æƒ…å†µ" required>${caseData?.description || ''}</textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>éš¾åº¦ *</label>
                            <select name="difficulty" required>
                                <option value="ç®€å•" ${caseData?.difficulty === 'ç®€å•' ? 'selected' : ''}>ç®€å•</option>
                                <option value="ä¸­ç­‰" ${!caseData || caseData?.difficulty === 'ä¸­ç­‰' ? 'selected' : ''}>ä¸­ç­‰</option>
                                <option value="å›°éš¾" ${caseData?.difficulty === 'å›°éš¾' ? 'selected' : ''}>å›°éš¾</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ­£ç¡®è¯Šæ–­ *</label>
                            <input type="text" name="diagnosis" value="${caseData?.diagnosis || ''}" placeholder="å¦‚ï¼šæ€¥æ€§å¿ƒè‚Œæ¢—æ­»" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>æ‚£è€…å¹´é¾„ *</label>
                            <input type="number" name="patient_age" value="${caseData?.patient_info?.age || '65'}" required>
                        </div>
                        <div class="form-group">
                            <label>æ‚£è€…æ€§åˆ« *</label>
                            <select name="patient_gender" required>
                                <option value="male" ${!caseData || caseData?.patient_info?.gender === 'male' ? 'selected' : ''}>ç”·</option>
                                <option value="female" ${caseData?.patient_info?.gender === 'female' ? 'selected' : ''}>å¥³</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>å…¶ä»–ä¿¡æ¯</label>
                        <input type="text" name="patient_extra" value="${caseData?.patient_info?.extra || ''}" placeholder="å¦‚ï¼šä½“é‡70kgï¼Œèº«é«˜175cm">
                    </div>
                    
                    <div class="form-group">
                        <label>ç—‡çŠ¶</label>
                        <div id="symptomsList">
                            ${(caseData?.symptoms || []).map(s => `
                                <div class="array-item" style="display:flex;gap:8px;margin-bottom:8px;">
                                    <input type="text" class="symptom-input" value="${s}" placeholder="ç—‡çŠ¶" style="flex:1;">
                                    <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">åˆ é™¤</button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addArrayItem('symptomsList', 'symptom-input', 'ç—‡çŠ¶')">+ æ·»åŠ ç—‡çŠ¶</button>
                    </div>
                    
                    <div class="form-group">
                        <label>é—®è¯Šé—®é¢˜</label>
                        <div id="questionsList">
                            ${(caseData?.questions || []).map(q => `
                                <div class="array-item" style="display:flex;gap:8px;margin-bottom:8px;">
                                    <input type="text" class="question-input" value="${typeof q === 'object' ? q.question : q}" placeholder="é—®é¢˜" style="flex:1;">
                                    <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">åˆ é™¤</button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addArrayItem('questionsList', 'question-input', 'é—®é¢˜')">+ æ·»åŠ é—®é¢˜</button>
                    </div>
                    
                    <div class="form-group">
                        <label>å‚è€ƒç­”æ¡ˆ</label>
                        <div id="answersList">
                            ${(caseData?.answers || []).map(a => `
                                <div class="array-item" style="display:flex;gap:8px;margin-bottom:8px;">
                                    <input type="text" class="answer-input" value="${typeof a === 'object' ? a.answer : a}" placeholder="ç­”æ¡ˆ" style="flex:1;">
                                    <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">åˆ é™¤</button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addArrayItem('answersList', 'answer-input', 'ç­”æ¡ˆ')">+ æ·»åŠ ç­”æ¡ˆ</button>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">${isEdit ? 'æ›´æ–°' : 'åˆ›å»º'}</button>
                    </div>
                </form>
            `;
            openModal(isEdit ? 'ç¼–è¾‘ç—…ä¾‹' : 'åˆ›å»ºç—…ä¾‹', content);
        }

        function addArrayItem(containerId, inputClass, placeholder) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'array-item';
            div.style.cssText = 'display:flex;gap:8px;margin-bottom:8px;';
            div.innerHTML = `
                <input type="text" class="${inputClass}" placeholder="${placeholder}" style="flex:1;">
                <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">åˆ é™¤</button>
            `;
            container.appendChild(div);
        }

        async function saveCase(e, id) {
            e.preventDefault();
            const form = e.target;
            
            const symptoms = Array.from(document.querySelectorAll('.symptom-input')).map(i => i.value).filter(v => v);
            const questions = Array.from(document.querySelectorAll('.question-input')).map(i => i.value).filter(v => v);
            const answers = Array.from(document.querySelectorAll('.answer-input')).map(i => i.value).filter(v => v);
            
            const data = {
                title: form.title.value,
                description: form.description.value,
                difficulty: form.difficulty.value,
                diagnosis: form.diagnosis.value,
                patient_info: {
                    age: parseInt(form.patient_age.value) || 0,
                    gender: form.patient_gender.value,
                    extra: form.patient_extra.value
                },
                symptoms,
                questions,
                answers
            };
            
            try {
                if (id) {
                    await fetch(`${API_BASE}/cases/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${currentToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    await apiPost('/cases', data);
                }
                
                closeModal();
                renderTeacherCases();
            } catch (err) {
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        async function viewCase(id) {
            try {
                const c = await apiGet(`/cases/${id}`);
                const content = `
                    <div class="space-y-4">
                        <p><strong>æ ‡é¢˜ï¼š</strong>${c.title}</p>
                        <p><strong>éš¾åº¦ï¼š</strong>${c.difficulty}</p>
                        <p><strong>è¯Šæ–­ï¼š</strong>${c.diagnosis}</p>
                        <p><strong>æè¿°ï¼š</strong>${c.description}</p>
                        <p><strong>æ‚£è€…ä¿¡æ¯ï¼š</strong>${c.patient_info?.age}å² ${c.patient_info?.gender === 'male' ? 'ç”·' : 'å¥³'}</p>
                        <p><strong>ç—‡çŠ¶ï¼š</strong>${c.symptoms?.join('ã€') || '-'}</p>
                    </div>
                `;
                openModal('ç—…ä¾‹è¯¦æƒ…', content);
            } catch (err) {
                alert('åŠ è½½å¤±è´¥');
            }
        }

        async function editCase(id) {
            try {
                const c = await apiGet(`/cases/${id}`);
                openCaseModal(c);
            } catch (err) {
                alert('åŠ è½½å¤±è´¥');
            }
        }

        async function deleteCase(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥ç—…ä¾‹å—ï¼Ÿ')) return;
            try {
                await apiDelete(`/cases/${id}`);
                renderTeacherCases();
            } catch (err) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // Class Modal
        function openClassModal() {
            const content = `
                <form onsubmit="saveClass(event)">
                    <div class="form-group">
                        <label>ç­çº§åç§° *</label>
                        <input type="text" name="name" required>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">åˆ›å»º</button>
                    </div>
                </form>
            `;
            openModal('åˆ›å»ºç­çº§', content);
        }

        async function saveClass(e) {
            e.preventDefault();
            const name = e.target.name.value;
            
            try {
                await apiPost('/classes', { name });
                closeModal();
                renderTeacherClasses();
            } catch (err) {
                alert('åˆ›å»ºå¤±è´¥');
            }
        }

        async function deleteClass(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥ç­çº§å—ï¼Ÿ')) return;
            try {
                await apiDelete(`/classes/${id}`);
                renderTeacherClasses();
            } catch (err) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        function manageClass(id) {
            alert('ç­çº§ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // Training functions
        async function startTraining(caseId) {
            try {
                const session = await apiPost('/sessions', { case_id: caseId });
                window.location.href = `/training.html?sessionId=${session.id}`;
            } catch (err) {
                alert('å¼€å§‹è®­ç»ƒå¤±è´¥');
            }
        }

        function continueTraining(sessionId) {
            window.location.href = `/training.html?sessionId=${sessionId}`;
        }

        function viewReport(sessionId) {
            window.location.href = `/report.html?sessionId=${sessionId}`;
        }

        // ==================== INIT ====================
        init();
    </script>
</body>
</html>