<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿä¸­å¿ƒ - ä¸´åºŠæ€ç»´è®­ç»ƒç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header .user-info { display: flex; align-items: center; gap: 20px; }
        .header .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none; color: white; padding: 8px 16px;
            border-radius: 8px; cursor: pointer;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px; }
        .welcome {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px;
            border-radius: 16px; margin-bottom: 30px;
        }
        .welcome h2 { font-size: 24px; margin-bottom: 8px; }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 24px; border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center;
        }
        .stat-card .value { font-size: 36px; font-weight: 700; color: #667eea; margin-bottom: 8px; }
        .stat-card .label { color: #666; font-size: 14px; }
        .section {
            background: white; border-radius: 16px; padding: 24px;
            margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .section h2 { font-size: 18px; color: #333; margin-bottom: 20px; }
        .case-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .case-card {
            border: 2px solid #e0e0e0; border-radius: 12px;
            padding: 20px; transition: all 0.3s; cursor: pointer;
        }
        .case-card:hover {
            border-color: #667eea; transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
        }
        .case-card h3 { font-size: 16px; color: #333; margin-bottom: 8px; }
        .case-card p { font-size: 14px; color: #666; margin-bottom: 12px; line-height: 1.5; }
        .case-card .meta { display: flex; justify-content: space-between; align-items: center; }
        .badge {
            display: inline-block; padding: 4px 12px;
            border-radius: 20px; font-size: 12px; font-weight: 500;
        }
        .badge-blue { background: #e3f2fd; color: #1976d2; }
        .badge-green { background: #e8f5e9; color: #388e3c; }
        .badge-orange { background: #fff3e0; color: #f57c00; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 8px 16px;
            border-radius: 8px; cursor: pointer; font-size: 13px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state .icon { font-size: 64px; margin-bottom: 16px; }
        
        /* Training Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white; border-radius: 16px; padding: 0;
            width: 95%; max-width: 900px; max-height: 95vh;
            overflow: hidden; display: flex; flex-direction: column;
        }
        .modal-header {
            display: flex; justify-content: space-between;
            align-items: center; padding: 20px 24px;
            border-bottom: 1px solid #eee;
        }
        .modal-header h3 { font-size: 18px; }
        .close-btn {
            background: none; border: none; font-size: 24px;
            cursor: pointer; color: #666;
        }
        .modal-body {
            flex: 1; overflow-y: auto; padding: 24px;
        }
        .chat-container {
            background: #f8f9fa; border-radius: 12px;
            padding: 20px; margin-bottom: 20px;
            max-height: 400px; overflow-y: auto;
        }
        .chat-message {
            margin-bottom: 16px; display: flex;
            flex-direction: column;
        }
        .chat-message.user { align-items: flex-end; }
        .chat-message.ai { align-items: flex-start; }
        .chat-bubble {
            max-width: 80%; padding: 12px 16px;
            border-radius: 16px; font-size: 14px;
            line-height: 1.5;
        }
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-bottom-right-radius: 4px;
        }
        .chat-message.ai .chat-bubble {
            background: white; color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chat-time { font-size: 11px; color: #999; margin-top: 4px; }
        .input-area {
            display: flex; gap: 12px; padding: 16px 24px;
            border-top: 1px solid #eee;
        }
        .input-area input {
            flex: 1; padding: 12px 16px;
            border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 14px;
        }
        .input-area input:focus { outline: none; border-color: #667eea; }
        .diagnosis-area {
            padding: 16px 24px; border-top: 1px solid #eee;
            background: #fafafa;
        }
        .diagnosis-area textarea {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 14px; min-height: 60px;
            margin-bottom: 12px; resize: vertical;
        }
        .patient-info {
            background: #e3f2fd; padding: 16px;
            border-radius: 8px; margin-bottom: 20px;
        }
        .patient-info h4 { color: #1976d2; margin-bottom: 8px; }
        .patient-info p { color: #333; font-size: 14px; line-height: 1.6; }
        .symptoms-list {
            display: flex; flex-wrap: wrap; gap: 8px;
            margin-bottom: 20px;
        }
        .symptom-tag {
            background: #fff3e0; color: #f57c00;
            padding: 4px 12px; border-radius: 16px;
            font-size: 12px;
        }
        .hint-box {
            background: #f5f5f5; padding: 12px 16px;
            border-radius: 8px; margin-bottom: 16px;
            font-size: 13px; color: #666;
        }
        .typing-indicator {
            display: none; padding: 12px 16px;
        }
        .typing-indicator.show { display: block; }
        .typing-indicator span {
            display: inline-block; width: 8px; height: 8px;
            background: #999; border-radius: 50%;
            margin: 0 2px; animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { color: #666; font-weight: 500; font-size: 13px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¥ ä¸´åºŠæ€ç»´è®­ç»ƒç³»ç»Ÿ - å­¦ç”Ÿä¸­å¿ƒ</h1>
        <div class="user-info">
            <span id="username">å­¦ç”Ÿ</span>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <div class="container">
        <div class="welcome">
            <h2>æ¬¢è¿å›æ¥ï¼ŒğŸ‘‹</h2>
            <p>é€‰æ‹©ä¸‹æ–¹ç—…ä¾‹å¼€å§‹è®­ç»ƒï¼Œé€šè¿‡ä¸AIåŠ©æ‰‹é—®è¯Šï¼Œæå‡ä½ çš„ä¸´åºŠè¯Šæ–­èƒ½åŠ›</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="value" id="totalSessions">0</div>
                <div class="label">æ€»è®­ç»ƒæ¬¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="value" id="completedSessions">0</div>
                <div class="label">å·²å®Œæˆ</div>
            </div>
            <div class="stat-card">
                <div class="value" id="averageScore">-</div>
                <div class="label">å¹³å‡åˆ†</div>
            </div>
            <div class="stat-card">
                <div class="value" id="casesAttempted">0</div>
                <div class="label">å°è¯•ç—…ä¾‹æ•°</div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“š å¯ç”¨ç—…ä¾‹</h2>
            <div id="casesList" class="case-grid">
                <div class="empty-state">
                    <div class="icon">ğŸ“–</div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“Š æœ€è¿‘è®­ç»ƒè®°å½•</h2>
            <div id="sessionsList">
                <div class="empty-state">
                    <div class="icon">ğŸ“</div>
                    <p>æš‚æ— è®­ç»ƒè®°å½•</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Training Modal -->
    <div class="modal" id="trainingModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h3 id="trainingTitle">ç—…ä¾‹è®­ç»ƒ</h3>
                    <span class="badge badge-blue" id="trainingDifficulty"></span>
                </div>
                <button class="close-btn" onclick="closeTrainingModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="patient-info" id="patientInfo"></div>
                <div class="symptoms-list" id="symptomsTags"></div>
                
                <div class="hint-box">
                    ğŸ’¡ æç¤ºï¼šä½ å¯ä»¥è¯¢é—®æ‚£è€…çš„ç—‡çŠ¶ã€ç—…å²ã€æ£€æŸ¥ç»“æœç­‰ä¿¡æ¯ï¼ŒAIåŠ©æ‰‹ä¼šæ ¹æ®ç—…ä¾‹èµ„æ–™å›ç­”ä½ ã€‚
                </div>
                
                <div class="chat-container" id="chatContainer">
                    <div class="chat-message ai">
                        <div class="chat-bubble">ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ã€‚è¯·å¼€å§‹ä½ çš„é—®è¯Šï¼Œæˆ‘ä¼šæ ¹æ®æ‚£è€…æƒ…å†µå›ç­”ä½ çš„é—®é¢˜ã€‚</div>
                        <div class="chat-time">ç°åœ¨</div>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
            
            <div class="input-area">
                <input type="text" id="chatInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼Œå¦‚ï¼šæ‚£è€…ç–¼ç—›éƒ¨ä½åœ¨å“ªï¼Ÿ"
                       onkeypress="if(event.key==='Enter')sendMessage()">
                <button class="btn" onclick="sendMessage()">å‘é€</button>
            </div>
            
            <div class="diagnosis-area">
                <h4>ğŸ“ æäº¤æœ€ç»ˆè¯Šæ–­</h4>
                <textarea id="diagnosisInput" placeholder="æ ¹æ®é—®è¯Šä¿¡æ¯ï¼Œè¯·è¾“å…¥ä½ çš„æœ€ç»ˆè¯Šæ–­..."></textarea>
                <div style="display:flex;gap:12px">
                    <button class="btn" onclick="submitDiagnosis()">æäº¤è¯Šæ–­</button>
                    <button class="btn btn-secondary" onclick="giveUp()">æ”¾å¼ƒè®­ç»ƒ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://clinical-thinking-backend.onrender.com';
        const token = localStorage.getItem('token');
        let currentSessionId = null;
        let currentCase = null;
        let chatHistory = [];
        
        if (!token) window.location.href = '/index.html';

        const username = localStorage.getItem('username') || 'å­¦ç”Ÿ';
        document.getElementById('username').textContent = username;
        document.querySelector('.welcome h2').textContent = `æ¬¢è¿å›æ¥ï¼Œ${username} ğŸ‘‹`;

        function logout() {
            localStorage.clear();
            window.location.href = '/index.html';
        }

        function openTrainingModal() {
            document.getElementById('trainingModal').classList.add('show');
        }
        function closeTrainingModal() {
            document.getElementById('trainingModal').classList.remove('show');
            currentSessionId = null;
            currentCase = null;
            chatHistory = [];
            document.getElementById('chatContainer').innerHTML = `
                <div class="chat-message ai">
                    <div class="chat-bubble">ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ã€‚è¯·å¼€å§‹ä½ çš„é—®è¯Šï¼Œæˆ‘ä¼šæ ¹æ®æ‚£è€…æƒ…å†µå›ç­”ä½ çš„é—®é¢˜ã€‚</div>
                    <div class="chat-time">ç°åœ¨</div>
                </div>
            `;
            document.getElementById('diagnosisInput').value = '';
            document.getElementById('typingIndicator').classList.remove('show');
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats/student`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                document.getElementById('totalSessions').textContent = data.total_sessions;
                document.getElementById('completedSessions').textContent = data.completed_sessions;
                document.getElementById('averageScore').textContent = data.average_score ? data.average_score.toFixed(0) : '-';
                document.getElementById('casesAttempted').textContent = data.total_cases_attempted;
            } catch (e) { console.error(e); }
        }

        async function loadCases() {
            try {
                const res = await fetch(`${API_BASE}/cases`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const cases = await res.json();
                const container = document.getElementById('casesList');
                container.innerHTML = cases.length ? cases.map(c => `
                    <div class="case-card" onclick="startTraining(${c.id})">
                        <h3>${c.title}</h3>
                        <p>${c.description.substring(0, 80)}...</p>
                        <div class="meta">
                            <span class="badge badge-blue">${c.difficulty}</span>
                            <button class="btn">å¼€å§‹è®­ç»ƒ</button>
                        </div>
                    </div>
                `).join('') : '<div class="empty-state" style="grid-column:1/-1"><div class="icon">ğŸ“–</div><p>æš‚æ— å¯ç”¨ç—…ä¾‹</p></div>';
            } catch (e) { console.error(e); }
        }

        async function startTraining(caseId) {
            try {
                const res = await fetch(`${API_BASE}/sessions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ case_id: caseId })
                });
                if (res.ok) {
                    const session = await res.json();
                    currentSessionId = session.id;
                    currentCase = session.case;
                    
                    document.getElementById('trainingTitle').textContent = session.case.title;
                    document.getElementById('trainingDifficulty').textContent = session.case.difficulty;
                    
                    const patientInfo = session.case.patient_info || {};
                    document.getElementById('patientInfo').innerHTML = `
                        <h4>ğŸ‘¤ æ‚£è€…ä¿¡æ¯</h4>
                        <p>${session.case.description}</p>
                        <p><strong>å¹´é¾„ï¼š</strong>${patientInfo.age || '-'}å² | 
                           <strong>æ€§åˆ«ï¼š</strong>${patientInfo.gender === 'male' ? 'ç”·' : patientInfo.gender === 'female' ? 'å¥³' : '-'}</p>
                        ${patientInfo.extra ? `<p><strong>å…¶ä»–ï¼š</strong>${patientInfo.extra}</p>` : ''}
                    `;
                    
                    const symptoms = session.case.symptoms || [];
                    document.getElementById('symptomsTags').innerHTML = symptoms.length ? 
                        symptoms.map(s => `<span class="symptom-tag">${s}</span>`).join('') : '';
                    
                    // åŠ è½½å†å²å¯¹è¯
                    loadChatHistory(session.id);
                    
                    openTrainingModal();
                } else alert('å¼€å§‹è®­ç»ƒå¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        async function loadChatHistory(sessionId) {
            try {
                const res = await fetch(`${API_BASE}/sessions/${sessionId}/dialogues`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const dialogues = await res.json();
                
                if (dialogues.length > 0) {
                    const container = document.getElementById('chatContainer');
                    container.innerHTML = '';
                    dialogues.forEach(d => {
                        addChatMessage(d.message, d.role, new Date(d.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }));
                    });
                }
            } catch (e) { console.error(e); }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message || !currentSessionId) return;
            
            addChatMessage(message, 'user');
            input.value = '';
            
            document.getElementById('typingIndicator').classList.add('show');
            
            try {
                await fetch(`${API_BASE}/dialogues`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message: message,
                        role: 'user'
                    })
                });
                
                // AIå›å¤
                const aiResponse = await getAIResponse(message);
                
                setTimeout(async () => {
                    document.getElementById('typingIndicator').classList.remove('show');
                    addChatMessage(aiResponse, 'ai');
                    
                    await fetch(`${API_BASE}/dialogues`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: currentSessionId,
                            message: aiResponse,
                            role: 'ai'
                        })
                    });
                }, 1000 + Math.random() * 1000);
            } catch (err) { 
                document.getElementById('typingIndicator').classList.remove('show');
                console.error(err); 
            }
        }

        async function getAIResponse(question) {
            if (!currentCase) return 'æŠ±æ­‰ï¼Œæˆ‘æ— æ³•å›ç­”ã€‚';
            
            const q = question.toLowerCase();
            const symptoms = currentCase.symptoms || [];
            const questions = currentCase.questions || [];
            const answers = currentCase.answers || [];
            const patientInfo = currentCase.patient_info || {};
            
            // æ™ºèƒ½åŒ¹é…å›ç­”
            if (q.includes('å¹´é¾„') || q.includes('å¤šå¤§')) {
                return `æ‚£è€…${patientInfo.age}å²ã€‚`;
            }
            if (q.includes('æ€§åˆ«') || q.includes('ç”·å¥³')) {
                return `æ‚£è€…æ˜¯${patientInfo.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§'}ã€‚`;
            }
            if (q.includes('ç—‡çŠ¶') || q.includes('ä¸èˆ’æœ') || q.includes('å“ªé‡Œ')) {
                return `æ‚£è€…ä¸»è¦ç—‡çŠ¶æœ‰ï¼š${symptoms.join('ã€')}ã€‚`;
            }
            if (q.includes('ç–¼ç—›') || q.includes('ç–¼')) {
                return symptoms.find(s => s.includes('ç—›')) || 'æ‚£è€…æœ‰ç–¼ç—›ç—‡çŠ¶ã€‚';
            }
            if (q.includes('å¤šä¹…') || q.includes('æ—¶é—´') || q.includes('å‡ å¤©')) {
                const idx = questions.findIndex(qs => qs.includes('å¤šä¹…') || qs.includes('æ—¶é—´'));
                return idx >= 0 ? answers[idx] : 'ç—‡çŠ¶æŒç»­ä¸€æ®µæ—¶é—´äº†ã€‚';
            }
            if (q.includes('ç—…å²') || q.includes('ä»¥å‰')) {
                const idx = questions.findIndex(qs => qs.includes('ç—…å²') || qs.includes('æ—¢å¾€'));
                return idx >= 0 ? answers[idx] : 'æ‚£è€…æœ‰ä¸€äº›æ—¢å¾€ç—…å²ã€‚';
            }
            if (q.includes('æ£€æŸ¥') || q.includes('ç»“æœ') || q.includes('åŒ–éªŒ')) {
                return 'ç›¸å…³æ£€æŸ¥ç»“æœéœ€è¦ç»“åˆä¸´åºŠè¡¨ç°ç»¼åˆåˆ¤æ–­ã€‚';
            }
            
            // åŒ¹é…é¢„è®¾é—®é¢˜
            for (let i = 0; i < questions.length; i++) {
                if (q.includes(questions[i].substring(0, 4))) {
                    return answers[i] || 'éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ç¡®è®¤ã€‚';
                }
            }
            
            // é»˜è®¤å›å¤
            const defaults = [
                'æ ¹æ®æ‚£è€…ç›®å‰çš„æƒ…å†µï¼Œå»ºè®®è¿›ä¸€æ­¥è¯¢é—®ç›¸å…³ç—‡çŠ¶ã€‚',
                'è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„è§‚å¯Ÿç‚¹ï¼Œè¯·ç»“åˆå…¶ä»–ç—‡çŠ¶ç»¼åˆåˆ¤æ–­ã€‚',
                'æ‚£è€…çš„æƒ…å†µéœ€è¦ä»”ç»†è¯„ä¼°ï¼Œå»ºè®®ç»§ç»­é—®è¯Šã€‚',
                'ä»ä¸´åºŠè¡¨ç°æ¥çœ‹ï¼Œè¿™éœ€è¦è¿›ä¸€æ­¥çš„é‰´åˆ«è¯Šæ–­ã€‚'
            ];
            return defaults[Math.floor(Math.random() * defaults.length)];
        }

        function addChatMessage(message, role, timeStr) {
            const container = document.getElementById('chatContainer');
            const time = timeStr || new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            container.innerHTML += `
                <div class="chat-message ${role}">
                    <div class="chat-bubble">${message}</div>
                    <div class="chat-time">${time}</div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        }

        async function submitDiagnosis() {
            const diagnosis = document.getElementById('diagnosisInput').value.trim();
            if (!diagnosis || !currentSessionId) {
                alert('è¯·è¾“å…¥è¯Šæ–­');
                return;
            }
            
            if (!confirm('ç¡®å®šæäº¤è¯Šæ–­å—ï¼Ÿæäº¤åå°†æ— æ³•ä¿®æ”¹ã€‚')) return;
            
            try {
                const res = await fetch(`${API_BASE}/sessions/${currentSessionId}/diagnosis`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ diagnosis })
                });
                
                if (res.ok) {
                    const result = await res.json();
                    const isCorrect = result.score >= 50;
                    alert(`ğŸ‰ è¯Šæ–­æäº¤æˆåŠŸï¼\n\nä½ çš„è¯Šæ–­ï¼š${diagnosis}\næ­£ç¡®è¯Šæ–­ï¼š${currentCase.diagnosis}\nå¾—åˆ†ï¼š${result.score}åˆ†\n\n${isCorrect ? 'âœ… è¯Šæ–­æ­£ç¡®ï¼' : 'âŒ è¯Šæ–­æœ‰è¯¯ï¼Œè¯·ç»§ç»­å­¦ä¹ ã€‚'}`);
                    closeTrainingModal();
                    loadStats();
                    loadSessions();
                } else alert('æäº¤å¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        function giveUp() {
            if (!confirm('ç¡®å®šæ”¾å¼ƒæœ¬æ¬¡è®­ç»ƒå—ï¼Ÿ')) return;
            closeTrainingModal();
        }

        async function loadSessions() {
            try {
                const res = await fetch(`${API_BASE}/sessions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const sessions = await res.json();
                const container = document.getElementById('sessionsList');
                
                if (sessions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“</div>
                            <p>æš‚æ— è®­ç»ƒè®°å½•</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ç—…ä¾‹</th>
                                    <th>çŠ¶æ€</th>
                                    <th>å¾—åˆ†</th>
                                    <th>æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sessions.slice(0, 5).map(s => `
                                    <tr>
                                        <td>${s.case ? s.case.title : 'æœªçŸ¥ç—…ä¾‹'}</td>
                                        <td>
                                            <span class="badge ${s.status === 'completed' ? 'badge-green' : 'badge-orange'}">
                                                ${s.status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}
                                            </span>
                                        </td>
                                        <td>${s.score !== null ? s.score + 'åˆ†' : '-'}</td>
                                        <td>${new Date(s.started_at).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (e) { console.error(e); }
        }

        loadStats(); loadCases(); loadSessions();
    </script>
</body>
</html>
