<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿä¸­å¿ƒ - ä¸´åºŠæ€ç»´è®­ç»ƒç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header .user-info { display: flex; align-items: center; gap: 20px; }
        .header .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none; color: white; padding: 8px 16px;
            border-radius: 8px; cursor: pointer;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px; }
        .welcome {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px;
            border-radius: 16px; margin-bottom: 30px;
        }
        .welcome h2 { font-size: 24px; margin-bottom: 8px; }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 24px; border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center;
        }
        .stat-card .value { font-size: 36px; font-weight: 700; color: #667eea; margin-bottom: 8px; }
        .stat-card .label { color: #666; font-size: 14px; }
        .section {
            background: white; border-radius: 16px; padding: 24px;
            margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .section h2 { font-size: 18px; color: #333; margin-bottom: 20px; }
        .case-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .case-card {
            border: 2px solid #e0e0e0; border-radius: 12px;
            padding: 20px; transition: all 0.3s; cursor: pointer;
        }
        .case-card:hover {
            border-color: #667eea; transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
        }
        .case-card h3 { font-size: 16px; color: #333; margin-bottom: 8px; }
        .case-card p { font-size: 14px; color: #666; margin-bottom: 12px; line-height: 1.5; }
        .case-card .meta { display: flex; justify-content: space-between; align-items: center; }
        .badge {
            display: inline-block; padding: 4px 12px;
            border-radius: 20px; font-size: 12px; font-weight: 500;
        }
        .badge-blue { background: #e3f2fd; color: #1976d2; }
        .badge-green { background: #e8f5e9; color: #388e3c; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 8px 16px;
            border-radius: 8px; cursor: pointer; font-size: 13px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state .icon { font-size: 64px; margin-bottom: 16px; }
        
        /* Training Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white; border-radius: 16px; padding: 30px;
            width: 90%; max-width: 800px; max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px;
        }
        .modal-header h3 { font-size: 20px; }
        .close-btn {
            background: none; border: none; font-size: 24px;
            cursor: pointer; color: #666;
        }
        .chat-container {
            background: #f8f9fa; border-radius: 12px;
            padding: 20px; margin-bottom: 20px;
            max-height: 400px; overflow-y: auto;
        }
        .chat-message {
            margin-bottom: 16px; display: flex;
            flex-direction: column;
        }
        .chat-message.user { align-items: flex-end; }
        .chat-message.ai { align-items: flex-start; }
        .chat-bubble {
            max-width: 80%; padding: 12px 16px;
            border-radius: 16px; font-size: 14px;
            line-height: 1.5;
        }
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-bottom-right-radius: 4px;
        }
        .chat-message.ai .chat-bubble {
            background: white; color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chat-time { font-size: 11px; color: #999; margin-top: 4px; }
        .input-area {
            display: flex; gap: 12px; margin-bottom: 20px;
        }
        .input-area input {
            flex: 1; padding: 12px 16px;
            border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 14px;
        }
        .input-area input:focus { outline: none; border-color: #667eea; }
        .diagnosis-area {
            border-top: 2px solid #eee; padding-top: 20px;
        }
        .diagnosis-area textarea {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 14px; min-height: 80px;
            margin-bottom: 12px; resize: vertical;
        }
        .patient-info {
            background: #e3f2fd; padding: 16px;
            border-radius: 8px; margin-bottom: 20px;
        }
        .patient-info h4 { color: #1976d2; margin-bottom: 8px; }
        .patient-info p { color: #333; font-size: 14px; line-height: 1.6; }
        .symptoms-list {
            display: flex; flex-wrap: wrap; gap: 8px;
            margin-bottom: 20px;
        }
        .symptom-tag {
            background: #fff3e0; color: #f57c00;
            padding: 4px 12px; border-radius: 16px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¥ ä¸´åºŠæ€ç»´è®­ç»ƒç³»ç»Ÿ - å­¦ç”Ÿä¸­å¿ƒ</h1>
        <div class="user-info">
            <span id="username">å­¦ç”Ÿ</span>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <div class="container">
        <div class="welcome">
            <h2>æ¬¢è¿å›æ¥ï¼ŒğŸ‘‹</h2>
            <p>é€‰æ‹©ä¸‹æ–¹ç—…ä¾‹å¼€å§‹è®­ç»ƒï¼Œæå‡ä½ çš„ä¸´åºŠè¯Šæ–­èƒ½åŠ›</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="value" id="totalSessions">-</div>
                <div class="label">æ€»è®­ç»ƒæ¬¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="value" id="completedSessions">-</div>
                <div class="label">å·²å®Œæˆ</div>
            </div>
            <div class="stat-card">
                <div class="value" id="averageScore">-</div>
                <div class="label">å¹³å‡åˆ†</div>
            </div>
            <div class="stat-card">
                <div class="value" id="casesAttempted">-</div>
                <div class="label">å°è¯•ç—…ä¾‹æ•°</div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“š å¯ç”¨ç—…ä¾‹</h2>
            <div id="casesList" class="case-grid">
                <div class="empty-state">
                    <div class="icon">ğŸ“–</div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“Š æœ€è¿‘è®­ç»ƒè®°å½•</h2>
            <div id="sessionsList">
                <div class="empty-state">
                    <div class="icon">ğŸ“</div>
                    <p>æš‚æ— è®­ç»ƒè®°å½•</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Training Modal -->
    <div class="modal" id="trainingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="trainingTitle">ç—…ä¾‹è®­ç»ƒ</h3>
                <button class="close-btn" onclick="closeTrainingModal()">&times;</button>
            </div>
            
            <div class="patient-info" id="patientInfo"></div>
            
            <div class="symptoms-list" id="symptomsTags"></div>
            
            <div class="chat-container" id="chatContainer">
                <div class="chat-message ai">
                    <div class="chat-bubble">ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œè¯·å¼€å§‹ä½ çš„é—®è¯Šã€‚</div>
                    <div class="chat-time">ç°åœ¨</div>
                </div>
            </div>
            
            <div class="input-area">
                <input type="text" id="chatInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
                       onkeypress="if(event.key==='Enter')sendMessage()">
                <button class="btn" onclick="sendMessage()">å‘é€</button>
            </div>
            
            <div class="diagnosis-area">
                <h4>ğŸ“ æäº¤è¯Šæ–­</h4>
                <textarea id="diagnosisInput" placeholder="è¯·è¾“å…¥ä½ çš„æœ€ç»ˆè¯Šæ–­..."></textarea>
                <button class="btn" onclick="submitDiagnosis()">æäº¤è¯Šæ–­</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://clinical-thinking-backend.onrender.com';
        const token = localStorage.getItem('token');
        let currentSessionId = null;
        let currentCase = null;
        
        if (!token) window.location.href = '/index.html';

        const username = localStorage.getItem('username') || 'å­¦ç”Ÿ';
        document.getElementById('username').textContent = username;
        document.querySelector('.welcome h2').textContent = `æ¬¢è¿å›æ¥ï¼Œ${username} ğŸ‘‹`;

        function logout() {
            localStorage.clear();
            window.location.href = '/index.html';
        }

        function openTrainingModal() {
            document.getElementById('trainingModal').classList.add('show');
        }
        function closeTrainingModal() {
            document.getElementById('trainingModal').classList.remove('show');
            currentSessionId = null;
            currentCase = null;
            document.getElementById('chatContainer').innerHTML = `
                <div class="chat-message ai">
                    <div class="chat-bubble">ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œè¯·å¼€å§‹ä½ çš„é—®è¯Šã€‚</div>
                    <div class="chat-time">ç°åœ¨</div>
                </div>
            `;
            document.getElementById('diagnosisInput').value = '';
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats/student`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                document.getElementById('totalSessions').textContent = data.total_sessions;
                document.getElementById('completedSessions').textContent = data.completed_sessions;
                document.getElementById('averageScore').textContent = data.average_score ? data.average_score.toFixed(0) : '-';
                document.getElementById('casesAttempted').textContent = data.total_cases_attempted;
            } catch (e) { console.error(e); }
        }

        async function loadCases() {
            try {
                const res = await fetch(`${API_BASE}/cases`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const cases = await res.json();
                const container = document.getElementById('casesList');
                container.innerHTML = cases.length ? cases.map(c => `
                    <div class="case-card" onclick="startTraining(${c.id})">
                        <h3>${c.title}</h3>
                        <p>${c.description.substring(0, 60)}...</p>
                        <div class="meta">
                            <span class="badge badge-blue">${c.difficulty}</span>
                            <button class="btn">å¼€å§‹è®­ç»ƒ</button>
                        </div>
                    </div>
                `).join('') : '<div class="empty-state" style="grid-column:1/-1"><div class="icon">ğŸ“–</div><p>æš‚æ— å¯ç”¨ç—…ä¾‹</p></div>';
            } catch (e) { console.error(e); }
        }

        async function startTraining(caseId) {
            try {
                const res = await fetch(`${API_BASE}/sessions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ case_id: caseId })
                });
                if (res.ok) {
                    const session = await res.json();
                    currentSessionId = session.id;
                    currentCase = session.case;
                    
                    document.getElementById('trainingTitle').textContent = session.case.title;
                    
                    // æ˜¾ç¤ºæ‚£è€…ä¿¡æ¯
                    const patientInfo = session.case.patient_info || {};
                    document.getElementById('patientInfo').innerHTML = `
                        <h4>ğŸ‘¤ æ‚£è€…ä¿¡æ¯</h4>
                        <p>${session.case.description}</p>
                        ${patientInfo.age ? `<p>å¹´é¾„: ${patientInfo.age}å² | æ€§åˆ«: ${patientInfo.gender === 'male' ? 'ç”·' : 'å¥³'}</p>` : ''}
                    `;
                    
                    // æ˜¾ç¤ºç—‡çŠ¶
                    const symptoms = session.case.symptoms || [];
                    document.getElementById('symptomsTags').innerHTML = symptoms.map(s => 
                        `<span class="symptom-tag">${s}</span>`
                    ).join('');
                    
                    openTrainingModal();
                } else alert('å¼€å§‹è®­ç»ƒå¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message || !currentSessionId) return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addChatMessage(message, 'user');
            input.value = '';
            
            try {
                await fetch(`${API_BASE}/dialogues`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message: message,
                        role: 'user'
                    })
                });
                
                // æ¨¡æ‹ŸAIå›å¤ï¼ˆå®é™…åº”è¯¥è°ƒç”¨AIæ¥å£ï¼‰
                setTimeout(() => {
                    const aiResponse = getAIResponse(message);
                    addChatMessage(aiResponse, 'ai');
                    
                    fetch(`${API_BASE}/dialogues`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: currentSessionId,
                            message: aiResponse,
                            role: 'ai'
                        })
                    });
                }, 1000);
            } catch (err) { console.error(err); }
        }

        function getAIResponse(question) {
            const responses = {
                'ç–¼ç—›': 'æ‚£è€…æè¿°ç–¼ç—›ä½äºèƒ¸éª¨åï¼Œå‘ˆå‹æ¦¨æ€§ï¼Œç–¼ç—›è¯„åˆ†8åˆ†ã€‚',
                'ç—…å²': 'æ‚£è€…æœ‰é«˜è¡€å‹ç—…å²5å¹´ï¼Œè§„å¾‹æœè¯ã€‚',
                'æ£€æŸ¥': 'å¿ƒç”µå›¾æ˜¾ç¤ºSTæ®µæŠ¬é«˜ï¼Œå¿ƒè‚Œé…¶è°±å‡é«˜ã€‚',
                'ç—‡çŠ¶': 'æ‚£è€…ä¼´æœ‰å‘¼å¸å›°éš¾ã€å‡ºæ±—ã€æ¶å¿ƒç­‰ç—‡çŠ¶ã€‚'
            };
            for (let key in responses) {
                if (question.includes(key)) return responses[key];
            }
            return 'è¯·ç»§ç»­è¯¢é—®æ›´å¤šç»†èŠ‚ï¼Œæˆ–æ ¹æ®å·²æœ‰ä¿¡æ¯è¿›è¡Œè¯Šæ–­ã€‚';
        }

        function addChatMessage(message, role) {
            const container = document.getElementById('chatContainer');
            const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            container.innerHTML += `
                <div class="chat-message ${role}">
                    <div class="chat-bubble">${message}</div>
                    <div class="chat-time">${time}</div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        }

        async function submitDiagnosis() {
            const diagnosis = document.getElementById('diagnosisInput').value.trim();
            if (!diagnosis || !currentSessionId) {
                alert('è¯·è¾“å…¥è¯Šæ–­');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/sessions/${currentSessionId}/diagnosis`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ diagnosis })
                });
                
                if (res.ok) {
                    const result = await res.json();
                    alert(`è¯Šæ–­æäº¤æˆåŠŸï¼\nä½ çš„è¯Šæ–­: ${diagnosis}\nå¾—åˆ†: ${result.score}åˆ†`);
                    closeTrainingModal();
                    loadStats();
                    loadSessions();
                } else alert('æäº¤å¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        async function loadSessions() {
            try {
                const res = await fetch(`${API_BASE}/sessions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const sessions = await res.json();
                const container = document.getElementById('sessionsList');
                
                if (sessions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“</div>
                            <p>æš‚æ— è®­ç»ƒè®°å½•</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <table style="width:100%">
                            <thead>
                                <tr>
                                    <th style="text-align:left;padding:12px">ç—…ä¾‹</th>
                                    <th style="text-align:left;padding:12px">çŠ¶æ€</th>
                                    <th style="text-align:left;padding:12px">å¾—åˆ†</th>
                                    <th style="text-align:left;padding:12px">æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sessions.slice(0, 5).map(s => `
                                    <tr>
                                        <td style="padding:12px">${s.case ? s.case.title : 'æœªçŸ¥ç—…ä¾‹'}</td>
                                        <td style="padding:12px">
                                            <span class="badge ${s.status === 'completed' ? 'badge-green' : 'badge-blue'}">
                                                ${s.status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}
                                            </span>
                                        </td>
                                        <td style="padding:12px">${s.score !== null ? s.score + 'åˆ†' : '-'}</td>
                                        <td style="padding:12px">${new Date(s.started_at).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (e) { console.error(e); }
        }

        loadStats(); loadCases(); loadSessions();
    </script>
</body>
</html>
