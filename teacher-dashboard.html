<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆå·¥ä½œå° - ä¸´åºŠæ€ç»´è®­ç»ƒç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header .user-info { display: flex; align-items: center; gap: 20px; }
        .header .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none; color: white; padding: 8px 16px;
            border-radius: 8px; cursor: pointer;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px; }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 24px; border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .stat-card .label { color: #666; font-size: 14px; margin-bottom: 8px; }
        .stat-card .value { font-size: 32px; font-weight: 700; color: #667eea; }
        .section {
            background: white; border-radius: 16px; padding: 24px;
            margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .section h2 { font-size: 18px; color: #333; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-size: 14px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-secondary {
            background: #f0f0f0; color: #333;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { color: #666; font-weight: 500; font-size: 13px; }
        .badge {
            display: inline-block; padding: 4px 12px;
            border-radius: 20px; font-size: 12px; font-weight: 500;
        }
        .badge-blue { background: #e3f2fd; color: #1976d2; }
        .badge-green { background: #e8f5e9; color: #388e3c; }
        .badge-orange { background: #fff3e0; color: #f57c00; }
        
        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white; border-radius: 16px; padding: 30px;
            width: 90%; max-width: 600px; max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px;
        }
        .modal-header h3 { font-size: 20px; }
        .close-btn {
            background: none; border: none; font-size: 24px;
            cursor: pointer; color: #666;
        }
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block; margin-bottom: 6px;
            font-size: 14px; color: #333; font-weight: 500;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px 14px;
            border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none; border-color: #667eea;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .array-input {
            display: flex; gap: 8px; margin-bottom: 8px;
        }
        .array-input input { flex: 1; }
        .array-input button {
            background: #ff4444; color: white; border: none;
            padding: 8px 12px; border-radius: 6px; cursor: pointer;
        }
        .add-item-btn {
            background: #4caf50; color: white; border: none;
            padding: 8px 16px; border-radius: 6px;
            cursor: pointer; font-size: 13px;
        }
        .modal-footer {
            display: flex; justify-content: flex-end;
            gap: 12px; margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¥ ä¸´åºŠæ€ç»´è®­ç»ƒç³»ç»Ÿ - æ•™å¸ˆå·¥ä½œå°</h1>
        <div class="user-info">
            <span id="username">æ•™å¸ˆ</span>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">æˆ‘çš„ç­çº§</div>
                <div class="value" id="classCount">-</div>
            </div>
            <div class="stat-card">
                <div class="label">å­¦ç”Ÿäººæ•°</div>
                <div class="value" id="studentCount">-</div>
            </div>
            <div class="stat-card">
                <div class="label">ç—…ä¾‹æ•°é‡</div>
                <div class="value" id="caseCount">-</div>
            </div>
            <div class="stat-card">
                <div class="label">è®­ç»ƒæ¬¡æ•°</div>
                <div class="value" id="sessionCount">-</div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <h2>ğŸ“š æˆ‘çš„ç—…ä¾‹</h2>
                <button class="btn" onclick="openCaseModal()">+ åˆ›å»ºç—…ä¾‹</button>
            </div>
            <table id="casesTable">
                <thead>
                    <tr>
                        <th>æ ‡é¢˜</th>
                        <th>éš¾åº¦</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-header">
                <h2>ğŸ‘¥ æˆ‘çš„ç­çº§</h2>
                <button class="btn" onclick="openClassModal()">+ åˆ›å»ºç­çº§</button>
            </div>
            <table id="classesTable">
                <thead>
                    <tr>
                        <th>ç­çº§åç§°</th>
                        <th>å­¦ç”Ÿäººæ•°</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Create Case Modal -->
    <div class="modal" id="caseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>åˆ›å»ºæ–°ç—…ä¾‹</h3>
                <button class="close-btn" onclick="closeCaseModal()">&times;</button>
            </div>
            <form id="caseForm" onsubmit="submitCase(event)">
                <div class="form-group">
                    <label>ç—…ä¾‹æ ‡é¢˜ *</label>
                    <input type="text" id="caseTitle" required placeholder="å¦‚ï¼šæ€¥æ€§èƒ¸ç—›ç—…ä¾‹">
                </div>
                <div class="form-group">
                    <label>ç—…ä¾‹æè¿° *</label>
                    <textarea id="caseDesc" required placeholder="æè¿°æ‚£è€…ä¸»è¯‰å’ŒåŸºæœ¬æƒ…å†µ"></textarea>
                </div>
                <div class="form-group">
                    <label>éš¾åº¦ *</label>
                    <select id="caseDifficulty" required>
                        <option value="ç®€å•">ç®€å•</option>
                        <option value="ä¸­ç­‰" selected>ä¸­ç­‰</option>
                        <option value="å›°éš¾">å›°éš¾</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ­£ç¡®è¯Šæ–­ *</label>
                    <input type="text" id="caseDiagnosis" required placeholder="å¦‚ï¼šæ€¥æ€§å¿ƒè‚Œæ¢—æ­»">
                </div>
                <div class="form-group">
                    <label>æ‚£è€…å¹´é¾„ *</label>
                    <input type="number" id="patientAge" required placeholder="å¦‚ï¼š65" value="65">
                </div>
                <div class="form-group">
                    <label>æ‚£è€…æ€§åˆ« *</label>
                    <select id="patientGender" required>
                        <option value="male" selected>ç”·</option>
                        <option value="female">å¥³</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å…¶ä»–ä¿¡æ¯</label>
                    <input type="text" id="patientExtra" placeholder="å¦‚ï¼šä½“é‡70kgï¼Œèº«é«˜175cm">
                </div>
                <div class="form-group">
                    <label>ç—‡çŠ¶</label>
                    <div id="symptomsList"></div>
                    <button type="button" class="add-item-btn" onclick="addSymptom()">+ æ·»åŠ ç—‡çŠ¶</button>
                </div>
                <div class="form-group">
                    <label>é—®è¯Šé—®é¢˜</label>
                    <div id="questionsList"></div>
                    <button type="button" class="add-item-btn" onclick="addQuestion()">+ æ·»åŠ é—®é¢˜</button>
                </div>
                <div class="form-group">
                    <label>å‚è€ƒç­”æ¡ˆ</label>
                    <div id="answersList"></div>
                    <button type="button" class="add-item-btn" onclick="addAnswer()">+ æ·»åŠ ç­”æ¡ˆ</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCaseModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Class Modal -->
    <div class="modal" id="classModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>åˆ›å»ºæ–°ç­çº§</h3>
                <button class="close-btn" onclick="closeClassModal()">&times;</button>
            </div>
            <form id="classForm" onsubmit="submitClass(event)">
                <div class="form-group">
                    <label>ç­çº§åç§° *</label>
                    <input type="text" id="className" required placeholder="å¦‚ï¼šä¸´åºŠåŒ»å­¦2024çº§1ç­">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeClassModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'https://clinical-thinking-backend.onrender.com';
        const token = localStorage.getItem('token');
        
        if (!token) window.location.href = '/index.html';

        document.getElementById('username').textContent = localStorage.getItem('username') || 'æ•™å¸ˆ';

        function logout() {
            localStorage.clear();
            window.location.href = '/index.html';
        }

        // Modal functions
        function openCaseModal() {
            document.getElementById('caseModal').classList.add('show');
            addSymptom(); addQuestion(); addAnswer();
        }
        function closeCaseModal() {
            document.getElementById('caseModal').classList.remove('show');
            document.getElementById('caseForm').reset();
        }
        function openClassModal() {
            document.getElementById('classModal').classList.add('show');
        }
        function closeClassModal() {
            document.getElementById('classModal').classList.remove('show');
            document.getElementById('classForm').reset();
        }

        // Dynamic form fields
        function addSymptom(val = '') {
            const div = document.createElement('div');
            div.className = 'array-input';
            div.innerHTML = `<input type="text" placeholder="ç—‡çŠ¶" value="${val}"><button type="button" onclick="this.parentElement.remove()">åˆ é™¤</button>`;
            document.getElementById('symptomsList').appendChild(div);
        }
        function addQuestion(val = '') {
            const div = document.createElement('div');
            div.className = 'array-input';
            div.innerHTML = `<input type="text" placeholder="é—®é¢˜" value="${val}"><button type="button" onclick="this.parentElement.remove()">åˆ é™¤</button>`;
            document.getElementById('questionsList').appendChild(div);
        }
        function addAnswer(val = '') {
            const div = document.createElement('div');
            div.className = 'array-input';
            div.innerHTML = `<input type="text" placeholder="ç­”æ¡ˆ" value="${val}"><button type="button" onclick="this.parentElement.remove()">åˆ é™¤</button>`;
            document.getElementById('answersList').appendChild(div);
        }

        // Submit functions
        async function submitCase(e) {
            e.preventDefault();
            const symptoms = Array.from(document.querySelectorAll('#symptomsList input')).map(i => i.value).filter(v => v);
            const questions = Array.from(document.querySelectorAll('#questionsList input')).map(i => i.value).filter(v => v);
            const answers = Array.from(document.querySelectorAll('#answersList input')).map(i => i.value).filter(v => v);
            
            const patientInfo = {
                age: parseInt(document.getElementById('patientAge').value),
                gender: document.getElementById('patientGender').value,
                extra: document.getElementById('patientExtra').value
            };
            
            const data = {
                title: document.getElementById('caseTitle').value,
                description: document.getElementById('caseDesc').value,
                difficulty: document.getElementById('caseDifficulty').value,
                diagnosis: document.getElementById('caseDiagnosis').value,
                patient_info: patientInfo,
                symptoms, questions, answers
            };

            try {
                const res = await fetch(`${API_BASE}/cases`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeCaseModal();
                    loadCases();
                    loadStats();
                } else alert('åˆ›å»ºå¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        async function submitClass(e) {
            e.preventDefault();
            try {
                const res = await fetch(`${API_BASE}/classes`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: document.getElementById('className').value })
                });
                if (res.ok) {
                    closeClassModal();
                    loadClasses();
                    loadStats();
                } else alert('åˆ›å»ºå¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        // Load data
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats/teacher`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                document.getElementById('classCount').textContent = data.total_classes;
                document.getElementById('studentCount').textContent = data.total_students;
                document.getElementById('caseCount').textContent = data.total_cases_created;
                document.getElementById('sessionCount').textContent = data.total_sessions;
            } catch (e) { console.error(e); }
        }

        async function loadCases() {
            try {
                const res = await fetch(`${API_BASE}/cases`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const cases = await res.json();
                const tbody = document.querySelector('#casesTable tbody');
                tbody.innerHTML = cases.length ? cases.map(c => `
                    <tr>
                        <td>${c.title}</td>
                        <td><span class="badge badge-blue">${c.difficulty}</span></td>
                        <td>${new Date(c.created_at).toLocaleDateString()}</td>
                        <td><button class="btn" style="padding:6px 12px;font-size:12px" onclick="viewCase(${c.id})">æŸ¥çœ‹</button></td>
                    </tr>
                `).join('') : '<tr><td colspan="4" style="text-align:center;color:#999">æš‚æ— ç—…ä¾‹</td></tr>';
            } catch (e) { console.error(e); }
        }

        async function loadClasses() {
            try {
                const res = await fetch(`${API_BASE}/classes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const classes = await res.json();
                const tbody = document.querySelector('#classesTable tbody');
                tbody.innerHTML = classes.length ? classes.map(c => `
                    <tr>
                        <td>${c.name}</td>
                        <td>${c.students ? c.students.length : 0} äºº</td>
                        <td>${new Date(c.created_at).toLocaleDateString()}</td>
                        <td><button class="btn" style="padding:6px 12px;font-size:12px">ç®¡ç†</button></td>
                    </tr>
                `).join('') : '<tr><td colspan="4" style="text-align:center;color:#999">æš‚æ— ç­çº§</td></tr>';
            } catch (e) { console.error(e); }
        }

        async function viewCase(caseId) {
            try {
                const res = await fetch(`${API_BASE}/cases/${caseId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const c = await res.json();
                
                const patientInfo = c.patient_info || {};
                const symptoms = c.symptoms || [];
                const questions = c.questions || [];
                const answers = c.answers || [];
                
                alert(`ç—…ä¾‹è¯¦æƒ…ï¼š

æ ‡é¢˜ï¼š${c.title}
éš¾åº¦ï¼š${c.difficulty}
è¯Šæ–­ï¼š${c.diagnosis}

æè¿°ï¼š
${c.description}

æ‚£è€…ä¿¡æ¯ï¼š
å¹´é¾„ï¼š${patientInfo.age || '-'}å²
æ€§åˆ«ï¼š${patientInfo.gender === 'male' ? 'ç”·' : patientInfo.gender === 'female' ? 'å¥³' : '-'}
å…¶ä»–ï¼š${patientInfo.extra || '-'}

ç—‡çŠ¶ï¼š${symptoms.join('ã€') || '-'}

é—®è¯Šé—®é¢˜ï¼š
${questions.map((q, i) => `${i+1}. ${q}`).join('\n') || '-'}

å‚è€ƒç­”æ¡ˆï¼š
${answers.map((a, i) => `${i+1}. ${a}`).join('\n') || '-'}

åˆ›å»ºæ—¶é—´ï¼š${new Date(c.created_at).toLocaleString()}`);
            } catch (err) {
                alert('æŸ¥çœ‹å¤±è´¥');
            }
        }

        loadStats(); loadCases(); loadClasses();
    </script>
</body>
</html>
