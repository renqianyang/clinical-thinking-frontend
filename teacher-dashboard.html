<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆå·¥ä½œå° - ä¸´åºŠæ€ç»´è®­ç»ƒç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header .user-info { display: flex; align-items: center; gap: 20px; }
        .header .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none; color: white; padding: 8px 16px;
            border-radius: 8px; cursor: pointer;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px; }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 24px; border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .stat-card .label { color: #666; font-size: 14px; margin-bottom: 8px; }
        .stat-card .value { font-size: 32px; font-weight: 700; color: #667eea; }
        .section {
            background: white; border-radius: 16px; padding: 24px;
            margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .section h2 { font-size: 18px; color: #333; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-size: 14px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-danger { background: #ff4444; color: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { color: #666; font-weight: 500; font-size: 13px; }
        .badge {
            display: inline-block; padding: 4px 12px;
            border-radius: 20px; font-size: 12px; font-weight: 500;
        }
        .badge-blue { background: #e3f2fd; color: #1976d2; }
        .badge-green { background: #e8f5e9; color: #388e3c; }
        .badge-orange { background: #fff3e0; color: #f57c00; }
        
        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white; border-radius: 16px; padding: 30px;
            width: 90%; max-width: 700px; max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px;
        }
        .modal-header h3 { font-size: 20px; }
        .close-btn {
            background: none; border: none; font-size: 24px;
            cursor: pointer; color: #666;
        }
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block; margin-bottom: 6px;
            font-size: 14px; color: #333; font-weight: 500;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px 14px;
            border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none; border-color: #667eea;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .array-input {
            display: flex; gap: 8px; margin-bottom: 8px;
        }
        .array-input input { flex: 1; }
        .array-input button {
            background: #ff4444; color: white; border: none;
            padding: 8px 12px; border-radius: 6px; cursor: pointer;
        }
        .add-item-btn {
            background: #4caf50; color: white; border: none;
            padding: 8px 16px; border-radius: 6px;
            cursor: pointer; font-size: 13px;
        }
        .modal-footer {
            display: flex; justify-content: flex-end;
            gap: 12px; margin-top: 20px;
        }
        .tabs {
            display: flex; gap: 20px; border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 0; cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500; color: #666;
        }
        .tab.active {
            color: #667eea; border-bottom-color: #667eea;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .student-list {
            max-height: 300px; overflow-y: auto;
        }
        .student-item {
            display: flex; justify-content: space-between;
            align-items: center; padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .student-item:hover { background: #f8f9fa; }
        .empty-state {
            text-align: center; padding: 40px; color: #999;
        }
        .detail-row {
            display: flex; margin-bottom: 12px;
        }
        .detail-label {
            width: 100px; color: #666; font-size: 14px;
        }
        .detail-value {
            flex: 1; color: #333; font-size: 14px;
        }
        .tag-list {
            display: flex; flex-wrap: wrap; gap: 8px;
        }
        .tag {
            background: #e3f2fd; color: #1976d2;
            padding: 4px 12px; border-radius: 16px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¥ ä¸´åºŠæ€ç»´è®­ç»ƒç³»ç»Ÿ - æ•™å¸ˆå·¥ä½œå°</h1>
        <div class="user-info">
            <span id="username">æ•™å¸ˆ</span>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">æˆ‘çš„ç­çº§</div>
                <div class="value" id="classCount">0</div>
            </div>
            <div class="stat-card">
                <div class="label">å­¦ç”Ÿäººæ•°</div>
                <div class="value" id="studentCount">0</div>
            </div>
            <div class="stat-card">
                <div class="label">ç—…ä¾‹æ•°é‡</div>
                <div class="value" id="caseCount">0</div>
            </div>
            <div class="stat-card">
                <div class="label">è®­ç»ƒæ¬¡æ•°</div>
                <div class="value" id="sessionCount">0</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('cases')">ğŸ“š ç—…ä¾‹ç®¡ç†</div>
            <div class="tab" onclick="switchTab('classes')">ğŸ‘¥ ç­çº§ç®¡ç†</div>
        </div>

        <div id="casesTab" class="tab-content active">
            <div class="section">
                <div class="section-header">
                    <h2>æˆ‘çš„ç—…ä¾‹</h2>
                    <div>
                        <button class="btn" onclick="openGenerateCaseModal()" style="margin-right:10px">âœ¨ AIç”Ÿæˆç—…ä¾‹</button>
                        <button class="btn" onclick="openCaseModal()">+ åˆ›å»ºç—…ä¾‹</button>
                    </div>
                </div>
                <table id="casesTable">
                    <thead>
                        <tr>
                            <th>æ ‡é¢˜</th>
                            <th>éš¾åº¦</th>
                            <th>è¯Šæ–­</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="classesTab" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>æˆ‘çš„ç­çº§</h2>
                    <button class="btn" onclick="openClassModal()">+ åˆ›å»ºç­çº§</button>
                </div>
                <table id="classesTable">
                    <thead>
                        <tr>
                            <th>ç­çº§åç§°</th>
                            <th>å­¦ç”Ÿäººæ•°</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create Case Modal -->
    <div class="modal" id="caseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>åˆ›å»ºæ–°ç—…ä¾‹</h3>
                <button class="close-btn" onclick="closeCaseModal()">&times;</button>
            </div>
            <form id="caseForm" onsubmit="submitCase(event)">
                <div class="form-group">
                    <label>ç—…ä¾‹æ ‡é¢˜ *</label>
                    <input type="text" id="caseTitle" required placeholder="å¦‚ï¼šæ€¥æ€§èƒ¸ç—›ç—…ä¾‹">
                </div>
                <div class="form-group">
                    <label>ç—…ä¾‹æè¿° *</label>
                    <textarea id="caseDesc" required placeholder="æè¿°æ‚£è€…ä¸»è¯‰å’ŒåŸºæœ¬æƒ…å†µ"></textarea>
                </div>
                <div class="form-group">
                    <label>éš¾åº¦ *</label>
                    <select id="caseDifficulty" required>
                        <option value="ç®€å•">ç®€å•</option>
                        <option value="ä¸­ç­‰" selected>ä¸­ç­‰</option>
                        <option value="å›°éš¾">å›°éš¾</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ­£ç¡®è¯Šæ–­ *</label>
                    <input type="text" id="caseDiagnosis" required placeholder="å¦‚ï¼šæ€¥æ€§å¿ƒè‚Œæ¢—æ­»">
                </div>
                <div class="form-group">
                    <label>æ‚£è€…å¹´é¾„ *</label>
                    <input type="number" id="patientAge" required placeholder="å¦‚ï¼š65" value="65">
                </div>
                <div class="form-group">
                    <label>æ‚£è€…æ€§åˆ« *</label>
                    <select id="patientGender" required>
                        <option value="male" selected>ç”·</option>
                        <option value="female">å¥³</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å…¶ä»–ä¿¡æ¯</label>
                    <input type="text" id="patientExtra" placeholder="å¦‚ï¼šä½“é‡70kgï¼Œèº«é«˜175cm">
                </div>
                <div class="form-group">
                    <label>ç—‡çŠ¶</label>
                    <div id="symptomsList"></div>
                    <button type="button" class="add-item-btn" onclick="addSymptom()">+ æ·»åŠ ç—‡çŠ¶</button>
                </div>
                <div class="form-group">
                    <label>é—®è¯Šé—®é¢˜</label>
                    <div id="questionsList"></div>
                    <button type="button" class="add-item-btn" onclick="addQuestion()">+ æ·»åŠ é—®é¢˜</button>
                </div>
                <div class="form-group">
                    <label>å‚è€ƒç­”æ¡ˆ</label>
                    <div id="answersList"></div>
                    <button type="button" class="add-item-btn" onclick="addAnswer()">+ æ·»åŠ ç­”æ¡ˆ</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCaseModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generate Case Modal -->
    <div class="modal" id="generateCaseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âœ¨ AIç”Ÿæˆç—…ä¾‹</h3>
                <button class="close-btn" onclick="closeGenerateCaseModal()">&times;</button>
            </div>
            <form id="generateCaseForm" onsubmit="submitGenerateCase(event)">
                <div class="form-group">
                    <label>ç—…ç§ç±»å‹ *</label>
                    <select id="generateDiseaseType" required>
                        <option value="">è¯·é€‰æ‹©ç—…ç§</option>
                        <option value="å¿ƒè¡€ç®¡ç–¾ç—…">å¿ƒè¡€ç®¡ç–¾ç—…</option>
                        <option value="å‘¼å¸ç³»ç»Ÿç–¾ç—…">å‘¼å¸ç³»ç»Ÿç–¾ç—…</option>
                        <option value="æ¶ˆåŒ–ç³»ç»Ÿç–¾ç—…">æ¶ˆåŒ–ç³»ç»Ÿç–¾ç—…</option>
                        <option value="ç¥ç»ç³»ç»Ÿç–¾ç—…">ç¥ç»ç³»ç»Ÿç–¾ç—…</option>
                        <option value="å†…åˆ†æ³Œç³»ç»Ÿç–¾ç—…">å†…åˆ†æ³Œç³»ç»Ÿç–¾ç—…</option>
                        <option value="æ³Œå°¿ç³»ç»Ÿç–¾ç—…">æ³Œå°¿ç³»ç»Ÿç–¾ç—…</option>
                        <option value="è¡€æ¶²ç³»ç»Ÿç–¾ç—…">è¡€æ¶²ç³»ç»Ÿç–¾ç—…</option>
                        <option value="æ„ŸæŸ“æ€§ç–¾ç—…">æ„ŸæŸ“æ€§ç–¾ç—…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>éš¾åº¦ *</label>
                    <select id="generateDifficulty" required>
                        <option value="ç®€å•">ç®€å•</option>
                        <option value="ä¸­ç­‰" selected>ä¸­ç­‰</option>
                        <option value="å›°éš¾">å›°éš¾</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç‰¹æ®Šè¦æ±‚ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="generateSpecial" placeholder="å¦‚ï¼šåˆå¹¶ç³–å°¿ç—…ã€è€å¹´æ‚£è€…ç­‰">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeGenerateCaseModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn" id="generateBtn">ç”Ÿæˆç—…ä¾‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Case Modal -->
    <div class="modal" id="viewCaseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç—…ä¾‹è¯¦æƒ…</h3>
                <button class="close-btn" onclick="closeViewCaseModal()">&times;</button>
            </div>
            <div id="caseDetailContent">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </div>

    <!-- Create Class Modal -->
    <div class="modal" id="classModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>åˆ›å»ºæ–°ç­çº§</h3>
                <button class="close-btn" onclick="closeClassModal()">&times;</button>
            </div>
            <form id="classForm" onsubmit="submitClass(event)">
                <div class="form-group">
                    <label>ç­çº§åç§° *</label>
                    <input type="text" id="className" required placeholder="å¦‚ï¼šä¸´åºŠåŒ»å­¦2024çº§1ç­">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeClassModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Class Modal -->
    <div class="modal" id="manageClassModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç®¡ç†ç­çº§</h3>
                <button class="close-btn" onclick="closeManageClassModal()">&times;</button>
            </div>
            <div id="manageClassContent">
                <div class="tabs">
                    <div class="tab active" onclick="switchClassTab('students')">ğŸ‘¥ ç­çº§å­¦ç”Ÿ</div>
                    <div class="tab" onclick="switchClassTab('add')">â• æ·»åŠ å­¦ç”Ÿ</div>
                </div>
                
                <div id="classStudentsTab" class="tab-content active">
                    <div class="student-list" id="classStudentList">
                        <div class="empty-state">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                
                <div id="addStudentTab" class="tab-content">
                    <div class="form-group">
                        <label>é€‰æ‹©å­¦ç”Ÿ</label>
                        <select id="studentSelect" style="width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                            <option>åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <button class="btn" onclick="addStudentToClass()">æ·»åŠ å­¦ç”Ÿ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://clinical-thinking-backend.onrender.com';
        const token = localStorage.getItem('token');
        let currentClassId = null;
        let allStudents = [];
        
        if (!token) window.location.href = '/index.html';

        document.getElementById('username').textContent = localStorage.getItem('username') || 'æ•™å¸ˆ';

        function logout() {
            localStorage.clear();
            window.location.href = '/index.html';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'cases') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('casesTab').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('classesTab').classList.add('active');
            }
        }

        function switchClassTab(tab) {
            document.querySelectorAll('#manageClassContent .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#manageClassContent .tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'students') {
                document.querySelector('#manageClassContent .tab:nth-child(1)').classList.add('active');
                document.getElementById('classStudentsTab').classList.add('active');
            } else {
                document.querySelector('#manageClassContent .tab:nth-child(2)').classList.add('active');
                document.getElementById('addStudentTab').classList.add('active');
            }
        }

        // Modal functions
        function openCaseModal() {
            document.getElementById('caseModal').classList.add('show');
            addSymptom(); addQuestion(); addAnswer();
        }
        function closeCaseModal() {
            document.getElementById('caseModal').classList.remove('show');
            document.getElementById('caseForm').reset();
        }
        function openGenerateCaseModal() {
            document.getElementById('generateCaseModal').classList.add('show');
        }
        function closeGenerateCaseModal() {
            document.getElementById('generateCaseModal').classList.remove('show');
            document.getElementById('generateCaseForm').reset();
        }
        function openClassModal() {
            document.getElementById('classModal').classList.add('show');
        }
        function closeClassModal() {
            document.getElementById('classModal').classList.remove('show');
            document.getElementById('classForm').reset();
        }
        function closeViewCaseModal() {
            document.getElementById('viewCaseModal').classList.remove('show');
        }
        function openManageClassModal(classId) {
            currentClassId = classId;
            document.getElementById('manageClassModal').classList.add('show');
            loadClassStudents(classId);
            loadAllStudents();
        }
        function closeManageClassModal() {
            document.getElementById('manageClassModal').classList.remove('show');
            currentClassId = null;
        }

        // Dynamic form fields
        function addSymptom(val = '') {
            const div = document.createElement('div');
            div.className = 'array-input';
            div.innerHTML = `<input type="text" placeholder="ç—‡çŠ¶" value="${val}"><button type="button" onclick="this.parentElement.remove()">åˆ é™¤</button>`;
            document.getElementById('symptomsList').appendChild(div);
        }
        function addQuestion(val = '') {
            const div = document.createElement('div');
            div.className = 'array-input';
            div.innerHTML = `<input type="text" placeholder="é—®é¢˜" value="${val}"><button type="button" onclick="this.parentElement.remove()">åˆ é™¤</button>`;
            document.getElementById('questionsList').appendChild(div);
        }
        function addAnswer(val = '') {
            const div = document.createElement('div');
            div.className = 'array-input';
            div.innerHTML = `<input type="text" placeholder="ç­”æ¡ˆ" value="${val}"><button type="button" onclick="this.parentElement.remove()">åˆ é™¤</button>`;
            document.getElementById('answersList').appendChild(div);
        }

        // AI Generate Case
        async function submitGenerateCase(e) {
            e.preventDefault();
            const diseaseType = document.getElementById('generateDiseaseType').value;
            const difficulty = document.getElementById('generateDifficulty').value;
            const special = document.getElementById('generateSpecial').value;
            
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = 'ç”Ÿæˆä¸­...';
            
            // æ¨¡æ‹ŸAIç”Ÿæˆç—…ä¾‹
            const generatedCase = generateMockCase(diseaseType, difficulty, special);
            
            try {
                const res = await fetch(`${API_BASE}/cases`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(generatedCase)
                });
                if (res.ok) {
                    closeGenerateCaseModal();
                    loadCases();
                    loadStats();
                    alert('AIç—…ä¾‹ç”ŸæˆæˆåŠŸï¼');
                } else alert('åˆ›å»ºå¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
            
            btn.disabled = false;
            btn.innerHTML = 'ç”Ÿæˆç—…ä¾‹';
        }

        function generateMockCase(diseaseType, difficulty, special) {
            const cases = {
                'å¿ƒè¡€ç®¡ç–¾ç—…': {
                    title: 'æ€¥æ€§èƒ¸ç—›æ‚£è€…',
                    description: 'æ‚£è€…çªå‘èƒ¸ç—›2å°æ—¶ï¼Œä¼´æœ‰å‡ºæ±—ã€æ¶å¿ƒã€‚æ—¢å¾€æœ‰é«˜è¡€å‹ç—…å²ã€‚',
                    diagnosis: 'æ€¥æ€§å¿ƒè‚Œæ¢—æ­»',
                    symptoms: ['èƒ¸ç—›', 'å‡ºæ±—', 'æ¶å¿ƒ', 'å‘¼å¸å›°éš¾'],
                    questions: ['ç–¼ç—›éƒ¨ä½ï¼Ÿ', 'ç–¼ç—›æ€§è´¨ï¼Ÿ', 'æŒç»­æ—¶é—´ï¼Ÿ', 'æ—¢å¾€ç—…å²ï¼Ÿ'],
                    answers: ['èƒ¸éª¨å', 'å‹æ¦¨æ€§ç–¼ç—›', 'æŒç»­2å°æ—¶', 'é«˜è¡€å‹5å¹´']
                },
                'å‘¼å¸ç³»ç»Ÿç–¾ç—…': {
                    title: 'æ…¢æ€§å’³å—½æ‚£è€…',
                    description: 'æ‚£è€…å’³å—½3ä¸ªæœˆï¼Œå’³ç™½è‰²é»ç—°ï¼Œæ´»åŠ¨åæ°”ä¿ƒã€‚å¸çƒŸå²20å¹´ã€‚',
                    diagnosis: 'æ…¢æ€§é˜»å¡æ€§è‚ºç–¾ç—…',
                    symptoms: ['æ…¢æ€§å’³å—½', 'å’³ç—°', 'æ°”ä¿ƒ', 'èƒ¸é—·'],
                    questions: ['å’³å—½å¤šä¹…äº†ï¼Ÿ', 'ç—°æ¶²æ€§çŠ¶ï¼Ÿ', 'å¸çƒŸå²ï¼Ÿ', 'æ´»åŠ¨å—é™ï¼Ÿ'],
                    answers: ['3ä¸ªæœˆ', 'ç™½è‰²é»ç—°', 'å¸çƒŸ20å¹´', 'ä¸Šæ¥¼æ°”ä¿ƒ']
                },
                'æ¶ˆåŒ–ç³»ç»Ÿç–¾ç—…': {
                    title: 'è…¹ç—›æ‚£è€…',
                    description: 'æ‚£è€…ä¸Šè…¹ç—›1å‘¨ï¼Œé¤ååŠ é‡ï¼Œä¼´åé…¸å—³æ°”ã€‚æ— é»‘ä¾¿ã€‚',
                    diagnosis: 'èƒƒæºƒç–¡',
                    symptoms: ['ä¸Šè…¹ç—›', 'åé…¸', 'å—³æ°”', 'é¤åç—›'],
                    questions: ['ç–¼ç—›éƒ¨ä½ï¼Ÿ', 'ä¸è¿›é£Ÿå…³ç³»ï¼Ÿ', 'æœ‰æ— é»‘ä¾¿ï¼Ÿ', 'æ—¢å¾€èƒƒç—…ï¼Ÿ'],
                    answers: ['ä¸Šè…¹éƒ¨', 'é¤ååŠ é‡', 'æ— é»‘ä¾¿', 'å¶æœ‰èƒƒç—›']
                },
                'ç¥ç»ç³»ç»Ÿç–¾ç—…': {
                    title: 'å¤´ç—›æ‚£è€…',
                    description: 'æ‚£è€…çªå‘å‰§çƒˆå¤´ç—›ï¼Œä¼´æ¶å¿ƒå‘•åï¼Œé¢ˆéƒ¨åƒµç¡¬ã€‚',
                    diagnosis: 'è››ç½‘è†œä¸‹è…”å‡ºè¡€',
                    symptoms: ['å‰§çƒˆå¤´ç—›', 'æ¶å¿ƒå‘•å', 'é¢ˆéƒ¨åƒµç¡¬', 'ç•å…‰'],
                    questions: ['å¤´ç—›æ€§è´¨ï¼Ÿ', 'å‘ç—…æ€¥ç¼“ï¼Ÿ', 'é¢ˆéƒ¨ç—‡çŠ¶ï¼Ÿ', 'æ„è¯†çŠ¶æ€ï¼Ÿ'],
                    answers: ['ç‚¸è£‚æ ·å‰§ç—›', 'çªå‘', 'é¢ˆéƒ¨åƒµç¡¬', 'æ¸…é†’']
                },
                'å†…åˆ†æ³Œç³»ç»Ÿç–¾ç—…': {
                    title: 'å¤šé¥®å¤šå°¿æ‚£è€…',
                    description: 'æ‚£è€…å¤šé¥®å¤šå°¿3ä¸ªæœˆï¼Œä½“é‡ä¸‹é™5kgï¼Œä¹åŠ›æ˜æ˜¾ã€‚',
                    diagnosis: '2å‹ç³–å°¿ç—…',
                    symptoms: ['å¤šé¥®', 'å¤šå°¿', 'ä½“é‡ä¸‹é™', 'ä¹åŠ›'],
                    questions: ['ç—‡çŠ¶å¤šä¹…ï¼Ÿ', 'ä½“é‡å˜åŒ–ï¼Ÿ', 'å®¶æ—å²ï¼Ÿ', 'é¥®é£Ÿæƒ…å†µï¼Ÿ'],
                    answers: ['3ä¸ªæœˆ', 'ä¸‹é™5kg', 'çˆ¶äº²ç³–å°¿ç—…', 'é£Ÿæ¬²äº¢è¿›']
                },
                'æ³Œå°¿ç³»ç»Ÿç–¾ç—…': {
                    title: 'è¡€å°¿æ‚£è€…',
                    description: 'æ‚£è€…æ— ç—›æ€§è‚‰çœ¼è¡€å°¿2å¤©ï¼Œæ— å°¿é¢‘å°¿æ€¥ã€‚',
                    diagnosis: 'è†€èƒ±è‚¿ç˜¤',
                    symptoms: ['è¡€å°¿', 'æ— ç—›æ€§', 'è‚‰çœ¼å¯è§', 'æ— åˆºæ¿€ç—‡çŠ¶'],
                    questions: ['è¡€å°¿ç‰¹ç‚¹ï¼Ÿ', 'ç–¼ç—›æƒ…å†µï¼Ÿ', 'æ’å°¿å¼‚å¸¸ï¼Ÿ', 'æ—¢å¾€ç—…å²ï¼Ÿ'],
                    answers: ['å…¨ç¨‹è¡€å°¿', 'æ— ç—›', 'æ— å°¿é¢‘å°¿æ€¥', 'æ— ç‰¹æ®Šç—…å²']
                },
                'è¡€æ¶²ç³»ç»Ÿç–¾ç—…': {
                    title: 'è´«è¡€æ‚£è€…',
                    description: 'æ‚£è€…é¢è‰²è‹ç™½ã€ä¹åŠ›2ä¸ªæœˆï¼Œæœˆç»é‡å¢å¤šã€‚',
                    diagnosis: 'ç¼ºé“æ€§è´«è¡€',
                    symptoms: ['é¢è‰²è‹ç™½', 'ä¹åŠ›', 'å¤´æ™•', 'å¿ƒæ‚¸'],
                    questions: ['ç—‡çŠ¶å¤šä¹…ï¼Ÿ', 'æœˆç»æƒ…å†µï¼Ÿ', 'é¥®é£Ÿæƒ…å†µï¼Ÿ', 'é»‘ä¾¿å²ï¼Ÿ'],
                    answers: ['2ä¸ªæœˆ', 'é‡å¢å¤š', 'åé£Ÿ', 'æ— é»‘ä¾¿']
                },
                'æ„ŸæŸ“æ€§ç–¾ç—…': {
                    title: 'å‘çƒ­æ‚£è€…',
                    description: 'æ‚£è€…é«˜çƒ­3å¤©ï¼Œä¼´å¯’æˆ˜ã€å’³å—½ï¼Œè¿‘æœŸæœ‰å¤–å‡ºå²ã€‚',
                    diagnosis: 'è‚ºç‚',
                    symptoms: ['é«˜çƒ­', 'å¯’æˆ˜', 'å’³å—½', 'èƒ¸ç—›'],
                    questions: ['å‘çƒ­ç‰¹ç‚¹ï¼Ÿ', 'ä¼´éšç—‡çŠ¶ï¼Ÿ', 'æ¥è§¦å²ï¼Ÿ', 'ç”¨è¯å²ï¼Ÿ'],
                    answers: ['æŒç»­é«˜çƒ­', 'å’³å—½å’³ç—°', 'è¿‘æœŸå¤–å‡º', 'æœªç”¨è¯']
                }
            };
            
            const baseCase = cases[diseaseType] || cases['å¿ƒè¡€ç®¡ç–¾ç—…'];
            
            return {
                title: special ? `${baseCase.title}ï¼ˆ${special}ï¼‰` : baseCase.title,
                description: baseCase.description + (special ? `åˆå¹¶${special}ã€‚` : ''),
                difficulty: difficulty,
                diagnosis: baseCase.diagnosis,
                patient_info: { age: 45 + Math.floor(Math.random() * 40), gender: 'male', extra: special || '' },
                symptoms: baseCase.symptoms,
                questions: baseCase.questions,
                answers: baseCase.answers
            };
        }

        // Submit functions
        async function submitCase(e) {
            e.preventDefault();
            const symptoms = Array.from(document.querySelectorAll('#symptomsList input')).map(i => i.value).filter(v => v);
            const questions = Array.from(document.querySelectorAll('#questionsList input')).map(i => i.value).filter(v => v);
            const answers = Array.from(document.querySelectorAll('#answersList input')).map(i => i.value).filter(v => v);
            
            const patientInfo = {
                age: parseInt(document.getElementById('patientAge').value),
                gender: document.getElementById('patientGender').value,
                extra: document.getElementById('patientExtra').value
            };
            
            const data = {
                title: document.getElementById('caseTitle').value,
                description: document.getElementById('caseDesc').value,
                difficulty: document.getElementById('caseDifficulty').value,
                diagnosis: document.getElementById('caseDiagnosis').value,
                patient_info: patientInfo,
                symptoms, questions, answers
            };

            try {
                const res = await fetch(`${API_BASE}/cases`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeCaseModal();
                    loadCases();
                    loadStats();
                } else alert('åˆ›å»ºå¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        async function submitClass(e) {
            e.preventDefault();
            try {
                const res = await fetch(`${API_BASE}/classes`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: document.getElementById('className').value })
                });
                if (res.ok) {
                    closeClassModal();
                    loadClasses();
                    loadStats();
                } else alert('åˆ›å»ºå¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        // Load data
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats/teacher`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                document.getElementById('classCount').textContent = data.total_classes;
                document.getElementById('studentCount').textContent = data.total_students;
                document.getElementById('caseCount').textContent = data.total_cases_created;
                document.getElementById('sessionCount').textContent = data.total_sessions;
            } catch (e) { console.error(e); }
        }

        async function loadCases() {
            try {
                const res = await fetch(`${API_BASE}/cases`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const cases = await res.json();
                const tbody = document.querySelector('#casesTable tbody');
                tbody.innerHTML = cases.length ? cases.map(c => `
                    <tr>
                        <td>${c.title}</td>
                        <td><span class="badge badge-blue">${c.difficulty}</span></td>
                        <td>${c.diagnosis}</td>
                        <td>${new Date(c.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn" style="padding:4px 8px;font-size:12px;margin-right:4px" onclick="viewCase(${c.id})">æŸ¥çœ‹</button>
                            <button class="btn" style="padding:4px 8px;font-size:12px;margin-right:4px;background:#4caf50" onclick="editCase(${c.id})">ç¼–è¾‘</button>
                            <button class="btn btn-danger" style="padding:4px 8px;font-size:12px" onclick="deleteCase(${c.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="5" style="text-align:center;color:#999">æš‚æ— ç—…ä¾‹</td></tr>';
            } catch (e) { console.error(e); }
        }

        async function viewCase(caseId) {
            try {
                const res = await fetch(`${API_BASE}/cases/${caseId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const c = await res.json();
                
                const patientInfo = c.patient_info || {};
                const symptoms = c.symptoms || [];
                const questions = c.questions || [];
                const answers = c.answers || [];
                
                document.getElementById('caseDetailContent').innerHTML = `
                    <div class="detail-row">
                        <div class="detail-label">æ ‡é¢˜ï¼š</div>
                        <div class="detail-value">${c.title}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">éš¾åº¦ï¼š</div>
                        <div class="detail-value"><span class="badge badge-blue">${c.difficulty}</span></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">è¯Šæ–­ï¼š</div>
                        <div class="detail-value"><span class="badge badge-green">${c.diagnosis}</span></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">æè¿°ï¼š</div>
                        <div class="detail-value">${c.description}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">æ‚£è€…ä¿¡æ¯ï¼š</div>
                        <div class="detail-value">
                            å¹´é¾„ï¼š${patientInfo.age || '-'}å² <br>
                            æ€§åˆ«ï¼š${patientInfo.gender === 'male' ? 'ç”·' : patientInfo.gender === 'female' ? 'å¥³' : '-'} <br>
                            å…¶ä»–ï¼š${patientInfo.extra || '-'}
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ç—‡çŠ¶ï¼š</div>
                        <div class="detail-value">
                            <div class="tag-list">${symptoms.map(s => `<span class="tag">${s}</span>`).join('') || '-'}</div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">é—®è¯Šé—®é¢˜ï¼š</div>
                        <div class="detail-value">
                            <ol>${questions.map(q => `<li>${q}</li>`).join('') || '-'}</ol>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">å‚è€ƒç­”æ¡ˆï¼š</div>
                        <div class="detail-value">
                            <ol>${answers.map(a => `<li>${a}</li>`).join('') || '-'}</ol>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">åˆ›å»ºæ—¶é—´ï¼š</div>
                        <div class="detail-value">${new Date(c.created_at).toLocaleString()}</div>
                    </div>
                `;
                document.getElementById('viewCaseModal').classList.add('show');
            } catch (err) {
                alert('æŸ¥çœ‹å¤±è´¥');
            }
        }

        async function loadClasses() {
            try {
                const res = await fetch(`${API_BASE}/classes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const classes = await res.json();
                const tbody = document.querySelector('#classesTable tbody');
                tbody.innerHTML = classes.length ? classes.map(c => `
                    <tr>
                        <td>${c.name}</td>
                        <td>${c.students ? c.students.length : 0} äºº</td>
                        <td>${new Date(c.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn" style="padding:4px 8px;font-size:12px;margin-right:4px" onclick="openManageClassModal(${c.id})">ç®¡ç†</button>
                            <button class="btn" style="padding:4px 8px;font-size:12px;margin-right:4px;background:#4caf50" onclick="editClass(${c.id}, '${c.name}')">ç¼–è¾‘</button>
                            <button class="btn btn-danger" style="padding:4px 8px;font-size:12px" onclick="deleteClass(${c.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="4" style="text-align:center;color:#999">æš‚æ— ç­çº§</td></tr>';
            } catch (e) { console.error(e); }
        }

        async function loadClassStudents(classId) {
            try {
                const res = await fetch(`${API_BASE}/classes/${classId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const cls = await res.json();
                const students = cls.students || [];
                
                document.getElementById('classStudentList').innerHTML = students.length ? students.map(s => `
                    <div class="student-item">
                        <span>${s.full_name} (${s.username})</span>
                        <button class="btn btn-danger" style="padding:4px 8px;font-size:12px" onclick="removeStudent(${classId}, ${s.id})">ç§»é™¤</button>
                    </div>
                `).join('') : '<div class="empty-state">æš‚æ— å­¦ç”Ÿ</div>';
            } catch (e) { console.error(e); }
        }

        async function loadAllStudents() {
            try {
                const res = await fetch(`${API_BASE}/users?role=student`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                allStudents = await res.json();
                
                const select = document.getElementById('studentSelect');
                select.innerHTML = allStudents.length ? 
                    '<option value="">è¯·é€‰æ‹©å­¦ç”Ÿ</option>' + 
                    allStudents.map(s => `<option value="${s.id}">${s.full_name} (${s.username})</option>`).join('') :
                    '<option>æš‚æ— å­¦ç”Ÿ</option>';
            } catch (e) { console.error(e); }
        }

        async function addStudentToClass() {
            const studentId = document.getElementById('studentSelect').value;
            if (!studentId || !currentClassId) return;
            
            try {
                const res = await fetch(`${API_BASE}/classes/${currentClassId}/students`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: parseInt(studentId) })
                });
                if (res.ok) {
                    loadClassStudents(currentClassId);
                    loadClasses();
                    loadStats();
                    alert('æ·»åŠ æˆåŠŸ');
                } else alert('æ·»åŠ å¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        async function removeStudent(classId, studentId) {
            if (!confirm('ç¡®å®šç§»é™¤è¯¥å­¦ç”Ÿï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API_BASE}/classes/${classId}/students/${studentId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    loadClassStudents(classId);
                    loadClasses();
                    loadStats();
                } else alert('ç§»é™¤å¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        // Edit and Delete Case
        let editingCaseId = null;

        async function editCase(caseId) {
            editingCaseId = caseId;
            try {
                const res = await fetch(`${API_BASE}/cases/${caseId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const c = await res.json();
                
                // Fill form
                document.getElementById('caseTitle').value = c.title;
                document.getElementById('caseDesc').value = c.description;
                document.getElementById('caseDifficulty').value = c.difficulty;
                document.getElementById('caseDiagnosis').value = c.diagnosis;
                
                const patientInfo = c.patient_info || {};
                document.getElementById('patientAge').value = patientInfo.age || '';
                document.getElementById('patientGender').value = patientInfo.gender || 'male';
                document.getElementById('patientExtra').value = patientInfo.extra || '';
                
                // Clear and fill arrays
                document.getElementById('symptomsList').innerHTML = '';
                (c.symptoms || []).forEach(s => addSymptom(s));
                
                document.getElementById('questionsList').innerHTML = '';
                (c.questions || []).forEach(q => addQuestion(q));
                
                document.getElementById('answersList').innerHTML = '';
                (c.answers || []).forEach(a => addAnswer(a));
                
                // Change form submit handler
                document.getElementById('caseForm').onsubmit = submitEditCase;
                document.querySelector('#caseModal h3').textContent = 'ç¼–è¾‘ç—…ä¾‹';
                
                openCaseModal();
            } catch (err) {
                alert('åŠ è½½å¤±è´¥');
            }
        }

        async function submitEditCase(e) {
            e.preventDefault();
            const symptoms = Array.from(document.querySelectorAll('#symptomsList input')).map(i => i.value).filter(v => v);
            const questions = Array.from(document.querySelectorAll('#questionsList input')).map(i => i.value).filter(v => v);
            const answers = Array.from(document.querySelectorAll('#answersList input')).map(i => i.value).filter(v => v);
            
            const patientInfo = {
                age: parseInt(document.getElementById('patientAge').value),
                gender: document.getElementById('patientGender').value,
                extra: document.getElementById('patientExtra').value
            };
            
            const data = {
                title: document.getElementById('caseTitle').value,
                description: document.getElementById('caseDesc').value,
                difficulty: document.getElementById('caseDifficulty').value,
                diagnosis: document.getElementById('caseDiagnosis').value,
                patient_info: patientInfo,
                symptoms, questions, answers
            };

            try {
                const res = await fetch(`${API_BASE}/cases/${editingCaseId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeCaseModal();
                    loadCases();
                    editingCaseId = null;
                    document.getElementById('caseForm').onsubmit = submitCase;
                    document.querySelector('#caseModal h3').textContent = 'åˆ›å»ºæ–°ç—…ä¾‹';
                } else alert('æ›´æ–°å¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        async function deleteCase(caseId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥ç—…ä¾‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            
            try {
                const res = await fetch(`${API_BASE}/cases/${caseId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    loadCases();
                    loadStats();
                    alert('åˆ é™¤æˆåŠŸ');
                } else alert('åˆ é™¤å¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        // Edit and Delete Class
        let editingClassId = null;

        function editClass(classId, className) {
            editingClassId = classId;
            document.getElementById('className').value = className;
            document.getElementById('classForm').onsubmit = submitEditClass;
            document.querySelector('#classModal h3').textContent = 'ç¼–è¾‘ç­çº§';
            openClassModal();
        }

        async function submitEditClass(e) {
            e.preventDefault();
            try {
                const res = await fetch(`${API_BASE}/classes/${editingClassId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: document.getElementById('className').value })
                });
                if (res.ok) {
                    closeClassModal();
                    loadClasses();
                    editingClassId = null;
                    document.getElementById('classForm').onsubmit = submitClass;
                    document.querySelector('#classModal h3').textContent = 'åˆ›å»ºæ–°ç­çº§';
                } else alert('æ›´æ–°å¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        async function deleteClass(classId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥ç­çº§å—ï¼Ÿç­çº§ä¸­çš„å­¦ç”Ÿå°†è¢«ç§»é™¤ã€‚æ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            
            try {
                const res = await fetch(`${API_BASE}/classes/${classId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    loadClasses();
                    loadStats();
                    alert('åˆ é™¤æˆåŠŸ');
                } else alert('åˆ é™¤å¤±è´¥');
            } catch (err) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        loadStats(); loadCases(); loadClasses();
    </script>
</body>
</html>
